<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Room | Ikazz - 48</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: '#E3F0E9',
                        blush: '#FFE5E5',
                        peach: '#FFE8D9',
                        dark: '#1C1C1E',
                        darkNavy: '#0f172a',
                        secondary: '#8E8E93',
                        divider: '#E5E5E7'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse-live {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        @keyframes reconnecting {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
        .animate-pulse-live { animation: pulse-live 2s ease-in-out infinite; }
        .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }
        .animate-reconnecting { animation: reconnecting 1s ease-in-out infinite; }
        
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
        }
        
        .glass-dark {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
        }
        
        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        .chat-bubble {
            animation: slideIn 0.2s ease-out;
        }
        
        .connection-indicator {
            transition: all 0.3s ease;
        }
        
        .video-container {
            transition: border-color 0.3s ease;
        }
        
        .video-container.connected { border-color: #10b981; }
        .video-container.connecting { border-color: #f59e0b; }
        .video-container.disconnected { border-color: #ef4444; }
        
        #remoteVideo {
            background: #0f172a;
        }
        
        .server-btn {
            transition: all 0.2s ease;
        }
        
        .server-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .tab-btn.active {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .member-card {
            transition: all 0.2s ease;
        }
        
        .member-card:hover {
            transform: scale(1.05);
        }
        
        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .right-panel { position: fixed; bottom: 0; left: 0; right: 0; height: 50vh; z-index: 30; }
        }
    </style>
</head>
<body class="bg-darkNavy min-h-screen text-white">
    <!-- Mobile Header -->
    <header class="lg:hidden fixed top-0 left-0 right-0 z-40 glass-dark border-b border-white/10">
        <div class="flex items-center justify-between px-4 py-3">
            <button onclick="exitRoom()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/10 hover:bg-white/20 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <div class="flex items-center gap-2">
                <span id="mobileConnectionStatus" class="w-2 h-2 rounded-full bg-yellow-500"></span>
                <span class="text-sm font-medium">Live Room</span>
            </div>
            <button onclick="toggleMobilePanel()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/10 hover:bg-white/20 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
            </button>
        </div>
    </header>

    <div class="flex min-h-screen">
        <!-- Sidebar - Desktop -->
        <aside class="sidebar hidden lg:flex flex-col w-60 bg-slate-900 border-r border-white/10 fixed h-full z-30">
            <div class="p-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-xl flex items-center justify-center">
                        <span class="font-bold text-white">48</span>
                    </div>
                    <div>
                        <h1 class="font-semibold">Ikazz - 48</h1>
                        <p class="text-xs text-slate-400">Live Streaming</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 px-4">
                <a href="index.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 transition-colors mb-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Home</span>
                </a>
                <a href="jadwal.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 transition-colors mb-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>Jadwal Show</span>
                </a>
                <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-emerald-500/20 text-emerald-400 mb-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    <span>Live Stage</span>
                </a>
            </nav>

            <div class="p-4 border-t border-white/10">
                <div class="flex items-center gap-2 mb-4">
                    <div id="connectionStatusDot" class="w-2 h-2 rounded-full bg-yellow-500 connection-indicator"></div>
                    <span id="connectionStatusText" class="text-xs text-slate-400">Connecting...</span>
                </div>
                <button onclick="exitRoom()" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <span>Keluar</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content flex-1 lg:ml-60 lg:mr-80 pt-16 lg:pt-0">
            <div class="p-4 lg:p-6">
                <!-- Video Container -->
                <div id="videoContainer" class="video-container connecting relative aspect-video bg-slate-900 rounded-2xl overflow-hidden border-2 mb-4 shadow-2xl">
                    <video id="remoteVideo" autoplay playsinline class="w-full h-full object-contain"></video>
                    
                    <!-- Video Overlay -->
                    <div class="absolute inset-0 pointer-events-none">
                        <!-- Top Overlay -->
                        <div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/60 to-transparent">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="flex items-center gap-1.5 bg-red-500 px-3 py-1 rounded-full text-sm font-medium">
                                        <span class="w-2 h-2 bg-white rounded-full animate-pulse-live"></span>
                                        LIVE
                                    </span>
                                    <span id="viewerCount" class="flex items-center gap-1.5 bg-black/40 px-3 py-1 rounded-full text-sm">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                        </svg>
                                        <span>0</span>
                                    </span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="latencyIndicator" class="bg-black/40 px-2 py-1 rounded-full text-xs">-- ms</span>
                                    <span id="bitrateIndicator" class="bg-black/40 px-2 py-1 rounded-full text-xs">-- kbps</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Overlay -->
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent">
                            <div class="flex items-center justify-between pointer-events-auto">
                                <button id="muteBtn" onclick="toggleMute()" class="w-10 h-10 rounded-full bg-black/40 flex items-center justify-center hover:bg-black/60 transition-colors">
                                    <svg id="muteIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                                    </svg>
                                </button>
                                <button onclick="toggleFullscreen()" class="w-10 h-10 rounded-full bg-black/40 flex items-center justify-center hover:bg-black/60 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Loading/Reconnecting Overlay -->
                    <div id="loadingOverlay" class="absolute inset-0 bg-slate-900/90 flex flex-col items-center justify-center">
                        <div class="w-16 h-16 border-4 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin mb-4"></div>
                        <p id="loadingText" class="text-lg font-medium mb-2">Menghubungkan...</p>
                        <p id="loadingSubtext" class="text-slate-400 text-sm">Mohon tunggu sebentar</p>
                        <button id="manualReconnectBtn" onclick="manualReconnect()" class="hidden mt-4 px-6 py-2 bg-emerald-500 rounded-xl hover:bg-emerald-600 transition-colors">
                            Coba Lagi
                        </button>
                    </div>
                </div>

                <!-- Server Switch -->
                <div class="flex items-center justify-center gap-2 mb-4">
                    <button id="server1Btn" onclick="switchServer(1)" class="server-btn active px-6 py-2 rounded-full bg-slate-800 text-sm font-medium">
                        Server 1 (Utama)
                    </button>
                    <button id="server2Btn" onclick="switchServer(2)" class="server-btn px-6 py-2 rounded-full bg-slate-800 text-sm font-medium">
                        Server 2 (Backup)
                    </button>
                </div>

                <!-- Stream Info Card -->
                <div class="bg-slate-800/50 rounded-2xl p-4 border border-white/10">
                    <div class="flex items-start gap-4">
                        <div id="streamThumbnail" class="w-16 h-16 rounded-xl bg-slate-700 flex-shrink-0 overflow-hidden">
                            <img src="" alt="" class="w-full h-full object-cover hidden">
                        </div>
                        <div class="flex-1 min-w-0">
                            <h2 id="streamTitle" class="font-semibold text-lg truncate">Loading...</h2>
                            <p id="streamDescription" class="text-slate-400 text-sm truncate mb-2">Loading description...</p>
                            <div class="flex items-center gap-2">
                                <span class="flex items-center gap-1 text-xs text-emerald-400">
                                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full"></span>
                                    Live
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Panel (Collapsible) -->
                <div class="mt-4">
                    <button onclick="toggleStatsPanel()" class="flex items-center gap-2 text-slate-400 text-sm hover:text-white transition-colors">
                        <svg id="statsArrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                        <span>Statistik Koneksi</span>
                    </button>
                    <div id="statsPanel" class="hidden mt-3 bg-slate-800/50 rounded-xl p-4 border border-white/10">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <p class="text-slate-400 text-xs mb-1">Connection</p>
                                <p id="statConnection" class="text-sm font-medium text-yellow-400">Connecting</p>
                            </div>
                            <div>
                                <p class="text-slate-400 text-xs mb-1">ICE State</p>
                                <p id="statIce" class="text-sm font-medium">--</p>
                            </div>
                            <div>
                                <p class="text-slate-400 text-xs mb-1">Bitrate</p>
                                <p id="statBitrate" class="text-sm font-medium">-- kbps</p>
                            </div>
                            <div>
                                <p class="text-slate-400 text-xs mb-1">FPS</p>
                                <p id="statFps" class="text-sm font-medium">--</p>
                            </div>
                            <div>
                                <p class="text-slate-400 text-xs mb-1">Resolution</p>
                                <p id="statResolution" class="text-sm font-medium">--</p>
                            </div>
                            <div>
                                <p class="text-slate-400 text-xs mb-1">Packet Loss</p>
                                <p id="statPacketLoss" class="text-sm font-medium">--%</p>
                            </div>
                            <div>
                                <p class="text-slate-400 text-xs mb-1">Jitter</p>
                                <p id="statJitter" class="text-sm font-medium">-- ms</p>
                            </div>
                            <div>
                                <p class="text-slate-400 text-xs mb-1">Round Trip</p>
                                <p id="statRtt" class="text-sm font-medium">-- ms</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel - Chat & Lineup -->
        <aside id="rightPanel" class="right-panel hidden lg:flex flex-col w-80 bg-slate-900 border-l border-white/10 fixed right-0 top-0 h-full z-30">
            <!-- Tab Buttons -->
            <div class="flex border-b border-white/10">
                <button onclick="switchTab('chat')" id="chatTabBtn" class="tab-btn active flex-1 py-4 text-sm font-medium text-center transition-colors">
                    Live Chat
                </button>
                <button onclick="switchTab('lineup')" id="lineupTabBtn" class="tab-btn flex-1 py-4 text-sm font-medium text-center text-slate-400 transition-colors">
                    Lineup
                </button>
            </div>

            <!-- Chat Tab -->
            <div id="chatTab" class="flex-1 flex flex-col">
                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin">
                    <!-- Messages will be inserted here -->
                </div>

                <!-- Slow Mode Indicator -->
                <div id="slowModeIndicator" class="hidden px-4 py-2 bg-yellow-500/20 text-yellow-400 text-xs text-center">
                    <span>⏱️ Slow Mode aktif: 10 detik</span>
                </div>

                <!-- Chat Input -->
                <div class="p-4 border-t border-white/10">
                    <div class="flex items-center gap-2">
                        <div class="flex-1 relative">
                            <input type="text" id="chatInput" placeholder="Tulis pesan..." class="w-full px-4 py-3 bg-slate-800 rounded-xl text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <button onclick="sendMessage()" class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center hover:bg-emerald-600 transition-colors flex-shrink-0">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lineup Tab -->
            <div id="lineupTab" class="hidden flex-1 overflow-y-auto p-4">
                <div id="lineupGrid" class="grid grid-cols-2 gap-3">
                    <!-- Members will be inserted here -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Mobile Panel Toggle -->
    <div id="mobilePanelContainer" class="lg:hidden fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-white/10 z-40 transform translate-y-full transition-transform duration-300">
        <div class="h-[50vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <div class="flex gap-4">
                    <button onclick="switchMobileTab('chat')" id="mobileChatBtn" class="text-sm font-medium text-emerald-400">Chat</button>
                    <button onclick="switchMobileTab('lineup')" id="mobileLineupBtn" class="text-sm font-medium text-slate-400">Lineup</button>
                </div>
                <button onclick="toggleMobilePanel()" class="w-8 h-8 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div id="mobileChatContent" class="flex-1 flex flex-col">
                <div id="mobileChatMessages" class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin"></div>
                <div class="p-4 border-t border-white/10">
                    <div class="flex items-center gap-2">
                        <input type="text" id="mobileChatInput" placeholder="Tulis pesan..." class="flex-1 px-4 py-3 bg-slate-800 rounded-xl text-white placeholder:text-slate-500 focus:outline-none">
                        <button onclick="sendMessage()" class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="mobileLineupContent" class="hidden flex-1 overflow-y-auto p-4">
                <div id="mobileLineupGrid" class="grid grid-cols-3 gap-3"></div>
            </div>
        </div>
    </div>

    <!-- Member Modal -->
    <div id="memberModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeMemberModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-80 bg-slate-800 rounded-2xl p-6 text-center">
            <img id="modalMemberPhoto" src="" alt="" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover">
            <h3 id="modalMemberName" class="text-xl font-semibold mb-1">Member Name</h3>
            <p id="modalMemberStatus" class="text-emerald-400 text-sm mb-4">Online</p>
            <p id="modalMemberDesc" class="text-slate-400 text-sm mb-6">Member description</p>
            <button class="w-full py-3 bg-emerald-500 rounded-xl font-medium hover:bg-emerald-600 transition-colors">
                Follow
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-50 opacity-0 transform -translate-y-4 transition-all duration-300 pointer-events-none">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 border border-white/10">
            <span id="toastIcon"></span>
            <span id="toastMessage" class="text-sm font-medium"></span>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config - Live Streaming
        const firebaseConfig = {
            apiKey: "AIzaSyDMQ961-vifb3R-Gurla3LbLM_489aHkHs-g",
            authDomain: "live2ke2.firebaseapp.com",
            projectId: "live2ke2",
            storageBucket: "live2ke2.firebasestorage.app",
            messagingSenderId: "861176752510",
            appId: "1:861176752510:web:0e1ee4e2d7f96c0b5dab2f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // State
        let roomId = new URLSearchParams(window.location.search).get('id');
        let pc = null;
        let viewerId = null;
        let currentServer = 1;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let statsInterval = null;
        let lastBytesReceived = 0;
        let lastTimestamp = 0;
        let isMuted = false;
        let currentUser = null;
        let unsubscribers = [];

        // ICE Servers
        const iceServers = {
            1: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ],
            2: [
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                { urls: 'stun:stun.stunprotocol.org:3478' }
            ]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (!roomId) {
                showToast('Room tidak ditemukan', 'error');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            // Get user info
            const loginToken = localStorage.getItem('loginToken');
            if (loginToken) {
                currentUser = { token: loginToken };
            }

            viewerId = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            await loadRoomInfo();
            await startViewing();
            loadChat();
            loadLineup();
            startStatsMonitoring();

            // Handle page unload
            window.addEventListener('beforeunload', cleanup);
        });

        // Load Room Info
        async function loadRoomInfo() {
            try {
                const doc = await db.collection('rooms').doc(roomId).get();
                if (!doc.exists) {
                    showToast('Room tidak ditemukan', 'error');
                    return;
                }

                const room = doc.data();
                document.getElementById('streamTitle').textContent = room.title || 'Live Streaming';
                document.getElementById('streamDescription').textContent = room.description || '';
                
                if (room.thumbnail) {
                    const img = document.querySelector('#streamThumbnail img');
                    img.src = room.thumbnail;
                    img.classList.remove('hidden');
                }

                // Listen for viewer count
                db.collection('rooms').doc(roomId).onSnapshot((snapshot) => {
                    if (snapshot.exists) {
                        const data = snapshot.data();
                        document.getElementById('viewerCount').innerHTML = `
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                            </svg>
                            <span>${data.viewerCount || 0}</span>
                        `;
                    }
                });
            } catch (error) {
                console.error('Error loading room:', error);
            }
        }

        // Start Viewing
        async function startViewing() {
            try {
                updateConnectionStatus('connecting');
                showLoading('Menghubungkan ke stream...');

                // Create peer connection
                pc = new RTCPeerConnection({ iceServers: iceServers[currentServer] });

                // Handle ICE candidates
                pc.onicecandidate = async (event) => {
                    if (event.candidate) {
                        await db.collection('rooms').doc(roomId)
                            .collection('viewerCandidates').doc(viewerId)
                            .collection('candidates').add(event.candidate.toJSON());
                    }
                };

                // Handle connection state
                pc.onconnectionstatechange = () => {
                    console.log('Connection state:', pc.connectionState);
                    updateConnectionStatus(pc.connectionState);
                    
                    if (pc.connectionState === 'connected') {
                        hideLoading();
                        reconnectAttempts = 0;
                        incrementViewerCount();
                    } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                        handleDisconnect();
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    document.getElementById('statIce').textContent = pc.iceConnectionState;
                };

                // Handle incoming track
                pc.ontrack = (event) => {
                    console.log('Received track:', event.track.kind);
                    const video = document.getElementById('remoteVideo');
                    if (event.streams && event.streams[0]) {
                        video.srcObject = event.streams[0];
                    }
                };

                // Add transceiver for receiving
                pc.addTransceiver('video', { direction: 'recvonly' });
                pc.addTransceiver('audio', { direction: 'recvonly' });

                // Create and send offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // Save viewer offer to Firestore
                await db.collection('rooms').doc(roomId)
                    .collection('viewers').doc(viewerId).set({
                        type: 'offer',
                        sdp: offer.sdp,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                // Listen for answer from broadcaster
                const unsubAnswer = db.collection('rooms').doc(roomId)
                    .collection('viewers').doc(viewerId).onSnapshot(async (snapshot) => {
                        const data = snapshot.data();
                        if (data && data.type === 'answer' && pc.signalingState !== 'stable') {
                            try {
                                await pc.setRemoteDescription(new RTCSessionDescription({
                                    type: 'answer',
                                    sdp: data.sdp
                                }));
                            } catch (e) {
                                console.error('Error setting remote description:', e);
                            }
                        }
                    });
                unsubscribers.push(unsubAnswer);

                // Listen for ICE candidates from broadcaster
                const unsubCandidates = db.collection('rooms').doc(roomId)
                    .collection('broadcasterCandidates').doc(viewerId)
                    .collection('candidates').onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach(async (change) => {
                            if (change.type === 'added') {
                                try {
                                    await pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                                } catch (e) {
                                    console.error('Error adding ICE candidate:', e);
                                }
                            }
                        });
                    });
                unsubscribers.push(unsubCandidates);

            } catch (error) {
                console.error('Error starting viewing:', error);
                showToast('Gagal menghubungkan', 'error');
                handleDisconnect();
            }
        }

        // Update Connection Status
        function updateConnectionStatus(state) {
            const dot = document.getElementById('connectionStatusDot');
            const text = document.getElementById('connectionStatusText');
            const mobileDot = document.getElementById('mobileConnectionStatus');
            const container = document.getElementById('videoContainer');
            const statConn = document.getElementById('statConnection');

            let color, statusText;
            container.classList.remove('connected', 'connecting', 'disconnected');

            switch(state) {
                case 'connected':
                    color = 'bg-emerald-500';
                    statusText = 'Connected';
                    container.classList.add('connected');
                    statConn.className = 'text-sm font-medium text-emerald-400';
                    break;
                case 'connecting':
                case 'new':
                    color = 'bg-yellow-500';
                    statusText = 'Connecting...';
                    container.classList.add('connecting');
                    statConn.className = 'text-sm font-medium text-yellow-400';
                    break;
                case 'disconnected':
                case 'failed':
                    color = 'bg-red-500';
                    statusText = 'Disconnected';
                    container.classList.add('disconnected');
                    statConn.className = 'text-sm font-medium text-red-400';
                    break;
                default:
                    color = 'bg-slate-500';
                    statusText = state;
            }

            dot.className = `w-2 h-2 rounded-full ${color} connection-indicator`;
            mobileDot.className = `w-2 h-2 rounded-full ${color}`;
            text.textContent = statusText;
            statConn.textContent = statusText;
        }

        // Handle Disconnect
        async function handleDisconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                showLoading(`Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`, 'Mencoba menghubungkan kembali');
                
                setTimeout(async () => {
                    await cleanup(false);
                    viewerId = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    await startViewing();
                }, 3000);
            } else {
                showLoading('Koneksi terputus', 'Klik tombol untuk mencoba lagi');
                document.getElementById('manualReconnectBtn').classList.remove('hidden');
            }
        }

        // Manual Reconnect
        async function manualReconnect() {
            reconnectAttempts = 0;
            document.getElementById('manualReconnectBtn').classList.add('hidden');
            await cleanup(false);
            viewerId = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            await startViewing();
        }

        // Switch Server
        async function switchServer(server) {
            if (currentServer === server) return;
            
            currentServer = server;
            
            document.getElementById('server1Btn').classList.toggle('active', server === 1);
            document.getElementById('server2Btn').classList.toggle('active', server === 2);
            
            showToast(`Beralih ke Server ${server}`, 'info');
            
            await cleanup(false);
            viewerId = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            await startViewing();
        }

        // Stats Monitoring
        function startStatsMonitoring() {
            statsInterval = setInterval(async () => {
                if (!pc || pc.connectionState !== 'connected') return;

                try {
                    const stats = await pc.getStats();
                    stats.forEach(report => {
                        if (report.type === 'inbound-rtp' && report.kind === 'video') {
                            // Bitrate calculation
                            const now = report.timestamp;
                            const bytes = report.bytesReceived;
                            if (lastTimestamp > 0) {
                                const bitrate = Math.round(8 * (bytes - lastBytesReceived) / (now - lastTimestamp));
                                document.getElementById('bitrateIndicator').textContent = `${bitrate} kbps`;
                                document.getElementById('statBitrate').textContent = `${bitrate} kbps`;
                            }
                            lastBytesReceived = bytes;
                            lastTimestamp = now;

                            // FPS
                            if (report.framesPerSecond) {
                                document.getElementById('statFps').textContent = Math.round(report.framesPerSecond);
                            }

                            // Resolution
                            if (report.frameWidth && report.frameHeight) {
                                document.getElementById('statResolution').textContent = `${report.frameWidth}x${report.frameHeight}`;
                            }

                            // Packet loss
                            if (report.packetsLost !== undefined && report.packetsReceived) {
                                const lossRate = (report.packetsLost / (report.packetsLost + report.packetsReceived) * 100).toFixed(1);
                                document.getElementById('statPacketLoss').textContent = `${lossRate}%`;
                            }

                            // Jitter
                            if (report.jitter) {
                                document.getElementById('statJitter').textContent = `${(report.jitter * 1000).toFixed(1)} ms`;
                            }
                        }

                        if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                            if (report.currentRoundTripTime) {
                                const rtt = Math.round(report.currentRoundTripTime * 1000);
                                document.getElementById('latencyIndicator').textContent = `${rtt} ms`;
                                document.getElementById('statRtt').textContent = `${rtt} ms`;
                            }
                        }
                    });
                } catch (e) {
                    console.error('Stats error:', e);
                }
            }, 1000);
        }

        // Viewer Count
        async function incrementViewerCount() {
            try {
                await db.collection('rooms').doc(roomId).update({
                    viewerCount: firebase.firestore.FieldValue.increment(1)
                });
            } catch (e) {
                console.error('Error incrementing viewer count:', e);
            }
        }

        async function decrementViewerCount() {
            try {
                await db.collection('rooms').doc(roomId).update({
                    viewerCount: firebase.firestore.FieldValue.increment(-1)
                });
            } catch (e) {
                console.error('Error decrementing viewer count:', e);
            }
        }

        // Chat Functions
        function loadChat() {
            const messagesContainer = document.getElementById('chatMessages');
            const mobileMessagesContainer = document.getElementById('mobileChatMessages');

            db.collection('rooms').doc(roomId)
                .collection('messages')
                .orderBy('createdAt', 'asc')
                .limitToLast(100)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const msg = change.doc.data();
                            const bubble = createChatBubble(msg);
                            messagesContainer.appendChild(bubble.cloneNode(true));
                            mobileMessagesContainer.appendChild(bubble);
                        }
                    });
                    
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    mobileMessagesContainer.scrollTop = mobileMessagesContainer.scrollHeight;
                });
        }

        function createChatBubble(msg) {
            const div = document.createElement('div');
            div.className = `chat-bubble p-3 rounded-xl ${msg.isAdmin ? 'bg-emerald-500/20 border border-emerald-500/30' : 'bg-slate-800'}`;
            
            const time = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '';
            
            div.innerHTML = `
                <div class="flex items-baseline gap-2 mb-1">
                    <span class="font-medium text-sm ${msg.isAdmin ? 'text-emerald-400' : 'text-white'}">${msg.userName || 'Anonymous'}</span>
                    ${msg.isAdmin ? '<span class="text-xs bg-emerald-500 text-white px-1.5 py-0.5 rounded">Admin</span>' : ''}
                    <span class="text-xs text-slate-500">${time}</span>
                </div>
                <p class="text-sm text-slate-300">${msg.text}</p>
            `;
            
            return div;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const mobileInput = document.getElementById('mobileChatInput');
            const text = (input.value || mobileInput.value).trim();
            
            if (!text) return;
            
            input.value = '';
            mobileInput.value = '';

            try {
                await db.collection('rooms').doc(roomId)
                    .collection('messages').add({
                        text: text,
                        userName: currentUser?.name || 'Guest',
                        userId: viewerId,
                        isAdmin: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
            } catch (e) {
                console.error('Error sending message:', e);
                showToast('Gagal mengirim pesan', 'error');
            }
        }

        // Enter key to send
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        document.getElementById('mobileChatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Lineup Functions
        function loadLineup() {
            db.collection('rooms').doc(roomId).onSnapshot((snapshot) => {
                if (!snapshot.exists) return;
                
                const room = snapshot.data();
                const lineup = room.lineup || [];
                
                const grid = document.getElementById('lineupGrid');
                const mobileGrid = document.getElementById('mobileLineupGrid');
                
                grid.innerHTML = '';
                mobileGrid.innerHTML = '';
                
                lineup.forEach((member) => {
                    const card = createMemberCard(member);
                    grid.appendChild(card.cloneNode(true));
                    mobileGrid.appendChild(card);
                });
            });
        }

        function createMemberCard(member) {
            const div = document.createElement('div');
            div.className = 'member-card bg-slate-800 rounded-xl p-3 text-center cursor-pointer';
            div.onclick = () => openMemberModal(member);
            
            div.innerHTML = `
                <div class="relative w-16 h-16 mx-auto mb-2">
                    <div class="w-full h-full rounded-full bg-gradient-to-br from-sage to-peach flex items-center justify-center text-xl font-medium text-emerald-700 overflow-hidden">
                        ${member.photo ? `<img src="${member.photo}" alt="${member.name}" class="w-full h-full object-cover">` : member.name?.[0] || 'M'}
                    </div>
                    ${member.isOnline ? '<span class="absolute bottom-0 right-0 w-4 h-4 bg-emerald-500 rounded-full border-2 border-slate-800"></span>' : ''}
                </div>
                <p class="text-sm font-medium truncate">${member.name}</p>
            `;
            
            return div;
        }

        function openMemberModal(member) {
            document.getElementById('modalMemberPhoto').src = member.photo || '';
            document.getElementById('modalMemberName').textContent = member.name;
            document.getElementById('modalMemberStatus').textContent = member.isOnline ? 'Online' : 'Offline';
            document.getElementById('modalMemberStatus').className = member.isOnline ? 'text-emerald-400 text-sm mb-4' : 'text-slate-400 text-sm mb-4';
            document.getElementById('modalMemberDesc').textContent = member.description || '';
            document.getElementById('memberModal').classList.remove('hidden');
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.add('hidden');
        }

        // UI Functions
        function toggleMute() {
            const video = document.getElementById('remoteVideo');
            isMuted = !isMuted;
            video.muted = isMuted;
            
            document.getElementById('muteIcon').innerHTML = isMuted
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>';
        }

        function toggleFullscreen() {
            const video = document.getElementById('remoteVideo');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                video.requestFullscreen();
            }
        }

        function toggleStatsPanel() {
            const panel = document.getElementById('statsPanel');
            const arrow = document.getElementById('statsArrow');
            panel.classList.toggle('hidden');
            arrow.style.transform = panel.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        function switchTab(tab) {
            document.getElementById('chatTab').classList.toggle('hidden', tab !== 'chat');
            document.getElementById('lineupTab').classList.toggle('hidden', tab !== 'lineup');
            document.getElementById('chatTabBtn').classList.toggle('active', tab === 'chat');
            document.getElementById('lineupTabBtn').classList.toggle('active', tab === 'lineup');
        }

        function toggleMobilePanel() {
            const panel = document.getElementById('mobilePanelContainer');
            panel.classList.toggle('translate-y-full');
        }

        function switchMobileTab(tab) {
            document.getElementById('mobileChatContent').classList.toggle('hidden', tab !== 'chat');
            document.getElementById('mobileLineupContent').classList.toggle('hidden', tab !== 'lineup');
            document.getElementById('mobileChatBtn').classList.toggle('text-emerald-400', tab === 'chat');
            document.getElementById('mobileChatBtn').classList.toggle('text-slate-400', tab !== 'chat');
            document.getElementById('mobileLineupBtn').classList.toggle('text-emerald-400', tab === 'lineup');
            document.getElementById('mobileLineupBtn').classList.toggle('text-slate-400', tab !== 'lineup');
        }

        function showLoading(text, subtext = 'Mohon tunggu sebentar') {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSubtext').textContent = subtext;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            msg.textContent = message;
            
            const icons = {
                success: '<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
                error: '<svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
                info: '<svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            };
            
            icon.innerHTML = icons[type] || icons.info;
            
            toast.classList.remove('opacity-0', '-translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', '-translate-y-4');
            }, 3000);
        }

        function exitRoom() {
            cleanup();
            window.location.href = 'index.html';
        }

        // Cleanup
        async function cleanup(redirect = true) {
            if (statsInterval) clearInterval(statsInterval);
            
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            
            if (pc) {
                pc.close();
                pc = null;
            }
            
            await decrementViewerCount();
            
            // Clean up Firestore
            try {
                await db.collection('rooms').doc(roomId)
                    .collection('viewers').doc(viewerId).delete();
            } catch (e) {
                console.error('Cleanup error:', e);
            }
        }
    </script>
</body>
</html>