<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | ikazz - 48</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { 'jakarta': ['Plus Jakarta Sans', 'sans-serif'] } } }
        }
    </script>
    <style>
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .slide-up { animation: slideUp 0.4s ease-out; }
        .scale-in { animation: scaleIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse-live { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pulse-live { animation: pulse-live 1.5s infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }
        .modal-overlay { backdrop-filter: blur(12px); }
        .tab-active { background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .has-\[\:checked\]\:border-emerald-500:has(:checked) { border-color: #10b981; }
        .has-\[\:checked\]\:bg-emerald-50:has(:checked) { background-color: #ecfdf5; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<!-- Login Screen -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl slide-up">
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-emerald-200/50">
                <span class="text-white font-extrabold text-3xl">48</span>
            </div>
            <h1 class="text-2xl font-extrabold text-gray-800">Admin Panel</h1>
            <p class="text-gray-500 mt-2">ikazz - 48 Live Streaming</p>
        </div>
        
        <!-- Tab Login Method -->
        <div class="flex bg-gray-100 rounded-xl p-1 mb-6">
            <button onclick="switchLoginMethod('email')" id="loginMethodEmail" class="flex-1 py-2.5 rounded-lg text-sm font-semibold bg-white text-emerald-600 shadow-sm transition-all">
                ğŸ“§ Email
            </button>
            <button onclick="switchLoginMethod('token')" id="loginMethodToken" class="flex-1 py-2.5 rounded-lg text-sm font-semibold text-gray-500 transition-all">
                ğŸ”‘ Token
            </button>
        </div>
        
        <!-- Email Login Form -->
        <div id="emailLoginForm" class="space-y-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                <input type="email" id="adminEmail" placeholder="admin@example.com" class="w-full px-4 py-3.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                <input type="password" id="adminPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-3.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all" onkeypress="if(event.key==='Enter')adminLoginEmail()">
            </div>
            <p id="loginError" class="text-red-500 text-sm hidden text-center"></p>
            <button onclick="adminLoginEmail()" class="w-full py-3.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-emerald-200/50 transition-all">
                Masuk dengan Email
            </button>
        </div>
        
        <!-- Token Login Form -->
        <div id="tokenLoginForm" class="hidden space-y-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Token Admin</label>
                <input type="text" id="adminToken" placeholder="Masukkan token admin..." class="w-full px-4 py-3.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all text-center font-mono text-lg tracking-widest uppercase" onkeypress="if(event.key==='Enter')adminLoginToken()">
            </div>
            <p id="tokenLoginError" class="text-red-500 text-sm hidden text-center"></p>
            <button onclick="adminLoginToken()" class="w-full py-3.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-emerald-200/50 transition-all">
                Masuk dengan Token
            </button>
        </div>
        
        <p class="text-center text-gray-400 text-sm mt-6">
            ğŸ”’ Area khusus admin
        </p>
    </div>
</div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white/95 backdrop-blur-lg border-b border-gray-100 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-11 h-11 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-200/50">
                        <span class="text-white font-extrabold">48</span>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-800">Admin Panel</h1>
                        <p class="text-xs text-gray-400" id="adminEmailDisplay"></p>
                    </div>
                </div>
                <button onclick="adminLogout()" class="px-4 py-2.5 text-red-500 hover:bg-red-50 rounded-xl transition-colors font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <span class="hidden sm:inline">Logout</span>
                </button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="bg-white border-b border-gray-100 sticky top-[72px] z-30">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex gap-2 py-3 overflow-x-auto scrollbar-hide">
                    <button onclick="showSection('broadcast')" id="tabBroadcast" class="px-4 py-2.5 rounded-xl text-sm font-semibold tab-active whitespace-nowrap transition-all">ğŸ“º Broadcast</button>
                    <button onclick="showSection('rooms')" id="tabRooms" class="px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-100 whitespace-nowrap transition-all">ğŸ  Rooms</button>
                    <button onclick="showSection('tokens')" id="tabTokens" class="px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-100 whitespace-nowrap transition-all">ğŸŸï¸ Tokens</button>
                    <button onclick="showSection('lineup')" id="tabLineup" class="px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-100 whitespace-nowrap transition-all">ğŸ‘¥ Lineup</button>
                    <button onclick="showSection('schedules')" id="tabSchedules" class="px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-100 whitespace-nowrap transition-all">ğŸ“… Jadwal</button>
                    <button onclick="showSection('notifications')" id="tabNotifications" class="px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-100 whitespace-nowrap transition-all">ğŸ”” Notifikasi</button>
                    <button onclick="showSection('users')" id="tabUsers" class="px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-100 whitespace-nowrap transition-all">ğŸ‘¤ Users</button>
                    <button onclick="showSection('chat')" id="tabChat" class="px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-100 whitespace-nowrap transition-all">ğŸ’¬ Chat</button>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="bg-gray-50 border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-4 py-2">
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-400">Quick Links:</span>
                    <a href="index.html" target="_blank" class="px-3 py-1 bg-white border border-gray-200 rounded-lg text-gray-600 hover:border-emerald-300 hover:text-emerald-600 transition-colors flex items-center gap-1">
                        ğŸ  Home
                    </a>
                    <a href="lineup.html" target="_blank" class="px-3 py-1 bg-white border border-gray-200 rounded-lg text-gray-600 hover:border-emerald-300 hover:text-emerald-600 transition-colors flex items-center gap-1">
                        ğŸ‘¥ Lineup
                    </a>
                    <a href="jadwal.html" target="_blank" class="px-3 py-1 bg-white border border-gray-200 rounded-lg text-gray-600 hover:border-emerald-300 hover:text-emerald-600 transition-colors flex items-center gap-1">
                        ğŸ“… Jadwal
                    </a>
                    <a href="prof.html" target="_blank" class="px-3 py-1 bg-white border border-gray-200 rounded-lg text-gray-600 hover:border-emerald-300 hover:text-emerald-600 transition-colors flex items-center gap-1">
                        ğŸ‘¤ Profil
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- ==================== BROADCAST SECTION ==================== -->
            <section id="sectionBroadcast" class="space-y-6 fade-in">
                <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ¬ Broadcast Control</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Room</label>
                            <select id="broadcastRoomSelect" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                                <option value="">-- Pilih Room --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                            <div id="broadcastStatus" class="flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-xl">
                                <span id="broadcastDot" class="w-3 h-3 bg-gray-400 rounded-full"></span>
                                <span id="broadcastStatusText" class="text-gray-600 font-medium">Tidak Aktif</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Sumber</label>
                        <div class="flex gap-3">
                            <button onclick="selectSource('screen')" id="sourceScreen" class="flex-1 px-4 py-3 border-2 border-emerald-500 bg-emerald-50 text-emerald-700 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                                ğŸ–¥ï¸ Screen Share
                            </button>
                            <button onclick="selectSource('camera')" id="sourceCamera" class="flex-1 px-4 py-3 border-2 border-gray-200 text-gray-600 rounded-xl font-semibold hover:border-gray-300 transition-all flex items-center justify-center gap-2">
                                ğŸ“· Camera
                            </button>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-wrap gap-3">
                        <button onclick="startBroadcast()" id="startBroadcastBtn" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center gap-2">
                            â–¶ï¸ Mulai Broadcast
                        </button>
                        <button onclick="stopBroadcast()" id="stopBroadcastBtn" class="hidden px-6 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-all flex items-center gap-2">
                            â¹ï¸ Stop Broadcast
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">ğŸ“¹ Preview</h3>
                        <div id="liveIndicator" class="hidden items-center gap-2 px-3 py-1.5 bg-red-500 rounded-full">
                            <span class="w-2 h-2 bg-white rounded-full pulse-live"></span>
                            <span class="text-white text-sm font-bold">LIVE</span>
                        </div>
                    </div>
                    <div class="aspect-video bg-gray-900 rounded-xl overflow-hidden relative">
                        <video id="localVideo" autoplay muted playsinline class="w-full h-full object-contain"></video>
                        <div id="previewOverlay" class="absolute inset-0 flex items-center justify-center bg-gray-900">
                            <div class="text-center text-gray-500">
                                <span class="text-6xl mb-4 block">ğŸ“¹</span>
                                <p class="font-medium text-lg">Belum ada stream</p>
                                <p class="text-sm text-gray-600 mt-1">Pilih room dan mulai broadcast</p>
                            </div>
                        </div>
                    </div>
                    <div id="viewersList" class="mt-4 hidden">
                        <div class="flex items-center justify-between bg-gray-50 rounded-xl p-4">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">ğŸ‘ï¸</span>
                                <span class="font-semibold text-gray-700">Viewers</span>
                            </div>
                            <span id="viewerCountAdmin" class="px-4 py-1.5 bg-emerald-500 text-white rounded-full text-sm font-bold">0</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ==================== ROOMS SECTION ==================== -->
            <section id="sectionRooms" class="hidden space-y-6 fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">ğŸ  Manage Rooms</h2>
                    <button onclick="showModal('createRoomModal')" class="px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center gap-2">
                        â• Buat Room
                    </button>
                </div>
                <div id="roomsList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-white rounded-2xl p-8 border-2 border-dashed border-gray-200 flex items-center justify-center text-gray-400">
                        <div class="text-center">
                            <span class="text-4xl block mb-2">ğŸ </span>
                            <p>Belum ada room</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ==================== TOKENS SECTION ==================== -->
            <section id="sectionTokens" class="hidden space-y-6 fade-in">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">ğŸŸï¸ Manage Tokens</h2>
                <div class="grid lg:grid-cols-2 gap-6">
                    <!-- Membership Tokens -->
                    <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">ğŸ« Membership Tokens</h3>
                            <button onclick="showModal('createMembershipTokenModal')" class="px-3 py-1.5 bg-emerald-500 text-white text-sm rounded-lg font-semibold hover:bg-emerald-600 transition-colors">+ Buat</button>
                        </div>
                        <div id="membershipTokensList" class="space-y-2 max-h-[400px] overflow-y-auto">
                            <div class="text-center py-8 text-gray-400">Belum ada token</div>
                        </div>
                    </div>

                    <!-- Watch Tokens -->
                    <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">ğŸ¬ Watch Tokens</h3>
                            <button onclick="showModal('createWatchTokenModal')" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg font-semibold hover:bg-blue-600 transition-colors">+ Buat</button>
                        </div>
                        <div id="watchTokensList" class="space-y-2 max-h-[400px] overflow-y-auto">
                            <div class="text-center py-8 text-gray-400">Belum ada token</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ==================== LINEUP SECTION ==================== -->
            <section id="sectionLineup" class="hidden space-y-6 fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">ğŸ‘¥ Manage Lineup</h2>
                    <button onclick="showModal('createMemberModal')" class="px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center gap-2">
                        â• Tambah Member
                    </button>
                </div>
                <div id="membersList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <div class="bg-white rounded-2xl p-8 border-2 border-dashed border-gray-200 flex items-center justify-center text-gray-400 col-span-full">
                        <div class="text-center">
                            <span class="text-4xl block mb-2">ğŸ‘¥</span>
                            <p>Belum ada member</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ==================== SCHEDULES SECTION ==================== -->
            <section id="sectionSchedules" class="hidden space-y-6 fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">ğŸ“… Manage Jadwal</h2>
                    <button onclick="showModal('createScheduleModal')" class="px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center gap-2">
                        â• Tambah Jadwal
                    </button>
                </div>
                <div id="schedulesList" class="space-y-3">
                    <div class="bg-white rounded-2xl p-8 border-2 border-dashed border-gray-200 text-center text-gray-400">
                        <span class="text-4xl block mb-2">ğŸ“…</span>
                        <p>Belum ada jadwal</p>
                    </div>
                </div>
            </section>

            <!-- ==================== NOTIFICATIONS SECTION ==================== -->
            <section id="sectionNotifications" class="hidden space-y-6 fade-in">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">ğŸ”” Kirim Notifikasi</h2>
                
                <div class="grid lg:grid-cols-2 gap-6">
                    <!-- Send Notification Form -->
                    <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4">ğŸ“¤ Kirim Notifikasi Baru</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Tipe Notifikasi</label>
                                <select id="notifType" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                                    <option value="info">ğŸ“¢ Info Umum</option>
                                    <option value="schedule">ğŸ“… Jadwal Baru</option>
                                    <option value="live">ğŸ”´ Live Sekarang</option>
                                    <option value="announcement">ğŸ“£ Pengumuman</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Judul</label>
                                <input type="text" id="notifTitle" placeholder="Judul notifikasi" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Pesan</label>
                                <textarea id="notifMessage" rows="4" placeholder="Isi pesan notifikasi..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none resize-none"></textarea>
                            </div>
                            <button onclick="sendNotification()" class="w-full py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-2">
                                ğŸš€ Kirim Notifikasi
                            </button>
                        </div>
                    </div>

                    <!-- Notification History -->
                    <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4">ğŸ“‹ Riwayat Notifikasi</h3>
                        <div id="notificationHistory" class="space-y-3 max-h-[400px] overflow-y-auto">
                            <div class="text-center py-8 text-gray-400">Belum ada notifikasi</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ==================== USERS SECTION ==================== -->
            <section id="sectionUsers" class="hidden space-y-6 fade-in">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">ğŸ‘¤ Cari & Kelola Users</h2>
                
                <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                    <div class="relative mb-6">
                        <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" id="searchUserInput" placeholder="Cari berdasarkan nama pengguna..." oninput="searchUsers()" class="w-full pl-12 pr-4 py-3.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                    </div>
                    
                    <div id="userSearchResults" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full text-center py-8 text-gray-400">
                            <span class="text-4xl block mb-2">ğŸ”</span>
                            <p>Ketik nama untuk mencari user</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ==================== CHAT SECTION ==================== -->
            <section id="sectionChat" class="hidden space-y-6 fade-in">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">ğŸ’¬ Live Chat Control</h2>
                
                <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Room</label>
                        <select id="chatRoomSelect" onchange="loadChatMessages()" class="w-full md:w-1/2 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                            <option value="">-- Pilih Room --</option>
                        </select>
                    </div>

                    <div id="chatContainer" class="hidden">
                        <div id="adminChatMessages" class="h-80 overflow-y-auto border border-gray-100 rounded-xl p-4 mb-4 bg-gray-50 space-y-3">
                            <div class="text-center py-8 text-gray-400">Pilih room untuk melihat chat</div>
                        </div>

                        <div class="flex gap-2">
                            <input type="text" id="adminChatInput" placeholder="Kirim pesan sebagai Admin..." 
                                class="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none"
                                onkeypress="if(event.key==='Enter')sendAdminMessage()">
                            <button onclick="sendAdminMessage()" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
                                Kirim
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Create Room Modal -->
    <div id="createRoomModal" class="fixed inset-0 bg-black/50 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 scale-in max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ  Buat Room Baru</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Judul Room *</label>
                    <input type="text" id="roomTitle" placeholder="Judul room" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Subtitle</label>
                    <input type="text" id="roomSubtitle" placeholder="Subtitle" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Deskripsi</label>
                    <textarea id="roomDescription" rows="3" placeholder="Deskripsi room..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Thumbnail URL</label>
                    <input type="text" id="roomThumbnail" placeholder="https://..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Host</label>
                    <input type="text" id="roomHost" placeholder="Nama host" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('createRoomModal')" class="flex-1 py-2.5 border border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50 transition-colors">Batal</button>
                <button onclick="createRoom()" class="flex-1 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all">Buat Room</button>
            </div>
        </div>
    </div>

    <!-- Create Membership Token Modal -->
    <div id="createMembershipTokenModal" class="fixed inset-0 bg-black/50 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 scale-in">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ« Buat Membership Token</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nama Member *</label>
                    <input type="text" id="membershipName" placeholder="Nama lengkap" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Durasi Membership</label>
                    <select id="membershipMonths" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                        <option value="1">1 Bulan</option>
                        <option value="3">3 Bulan</option>
                        <option value="6">6 Bulan</option>
                        <option value="12">12 Bulan</option>
                    </select>
                </div>
            </div>
            <div id="generatedMembershipToken" class="hidden mt-4 p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                <p class="text-sm text-gray-600 mb-2">âœ… Token berhasil dibuat:</p>
                <p class="font-mono text-xl font-bold text-emerald-700 break-all text-center py-2 bg-white rounded-lg" id="membershipTokenValue"></p>
                <button onclick="copyToken('membershipTokenValue')" class="mt-3 w-full py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600 transition-colors flex items-center justify-center gap-2">
                    ğŸ“‹ Copy Token
                </button>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('createMembershipTokenModal')" class="flex-1 py-2.5 border border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50 transition-colors">Tutup</button>
                <button onclick="createMembershipToken()" class="flex-1 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all">Buat Token</button>
            </div>
        </div>
    </div>

    <!-- Create Watch Token Modal -->
    <div id="createWatchTokenModal" class="fixed inset-0 bg-black/50 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 scale-in">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ¬ Buat Watch Token</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Room (Opsional)</label>
                    <select id="watchTokenRoom" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                        <option value="">Semua Room</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Jumlah Token</label>
                    <input type="number" id="watchTokenCount" value="1" min="1" max="100" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
            </div>
            <div id="generatedWatchTokens" class="hidden mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200 max-h-48 overflow-y-auto">
                <p class="text-sm text-gray-600 mb-2">âœ… Token berhasil dibuat:</p>
                <div id="watchTokensValues" class="space-y-1 font-mono text-sm bg-white rounded-lg p-2"></div>
                <button onclick="copyAllWatchTokens()" class="mt-3 w-full py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    ğŸ“‹ Copy Semua
                </button>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('createWatchTokenModal')" class="flex-1 py-2.5 border border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50 transition-colors">Tutup</button>
                <button onclick="createWatchTokens()" class="flex-1 py-2.5 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600 transition-all">Buat Token</button>
            </div>
        </div>
    </div>

    <!-- Create Member Modal (UPDATED) -->
    <div id="createMemberModal" class="fixed inset-0 bg-black/50 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 scale-in max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ‘¤ Tambah Member Lineup</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nama Member *</label>
                    <input type="text" id="newMemberName" placeholder="Nama member" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Foto URL</label>
                    <input type="text" id="newMemberPhoto" placeholder="https://..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                    <p class="text-xs text-gray-400 mt-1">Kosongkan untuk auto-generate avatar</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Info / Generasi</label>
                    <input type="text" id="newMemberInfo" placeholder="Gen 10, Tim J, dll" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Urutan</label>
                        <input type="number" id="newMemberOrder" value="1" min="1" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <div class="flex items-end pb-1">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="newMemberOnline" class="w-5 h-5 text-emerald-500 rounded">
                            <span class="text-sm text-gray-700 font-medium">ğŸŸ¢ Online</span>
                        </label>
                    </div>
                </div>
                
                <!-- Social Media Links -->
                <div class="border-t border-gray-100 pt-4 mt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“± Social Media (Opsional)</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="w-8 text-center">ğŸ“¸</span>
                            <input type="text" id="newMemberInstagram" placeholder="Username Instagram" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-8 text-center">ğŸ¦</span>
                            <input type="text" id="newMemberTwitter" placeholder="Username Twitter/X" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-8 text-center">ğŸµ</span>
                            <input type="text" id="newMemberTiktok" placeholder="Username TikTok" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="border-t border-gray-100 pt-4 mt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“Š Stats (Opsional)</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-500">Followers</label>
                            <input type="number" id="newMemberFollowers" value="0" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Total Lives</label>
                            <input type="number" id="newMemberLives" value="0" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('createMemberModal')" class="flex-1 py-2.5 border border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50 transition-colors">Batal</button>
                <button onclick="createMember()" class="flex-1 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all">Tambah</button>
            </div>
        </div>
    </div>

    <!-- Create Schedule Modal (UPDATED) -->
    <div id="createScheduleModal" class="fixed inset-0 bg-black/50 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 scale-in max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ“… Tambah Jadwal</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Judul *</label>
                    <input type="text" id="scheduleTitle" placeholder="Judul acara" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Tanggal & Waktu *</label>
                    <input type="datetime-local" id="scheduleDate" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Deskripsi</label>
                    <textarea id="scheduleDescription" rows="3" placeholder="Deskripsi acara..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none resize-none"></textarea>
                </div>
                
                <!-- Schedule Type -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tipe Jadwal</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex flex-col items-center gap-1 p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-emerald-300 transition-all has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                            <input type="radio" name="scheduleType" value="live" class="hidden" checked>
                            <span class="text-2xl">ğŸ¬</span>
                            <span class="text-xs font-medium">Live Show</span>
                        </label>
                        <label class="flex flex-col items-center gap-1 p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-emerald-300 transition-all has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                            <input type="radio" name="scheduleType" value="event" class="hidden">
                            <span class="text-2xl">ğŸ‰</span>
                            <span class="text-xs font-medium">Event</span>
                        </label>
                        <label class="flex flex-col items-center gap-1 p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-emerald-300 transition-all has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                            <input type="radio" name="scheduleType" value="theater" class="hidden">
                            <span class="text-2xl">ğŸ­</span>
                            <span class="text-xs font-medium">Theater</span>
                        </label>
                    </div>
                </div>

                <!-- Thumbnail -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Thumbnail URL (Opsional)</label>
                    <input type="text" id="scheduleThumbnail" placeholder="https://..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>

                <!-- Notification Option -->
                <div class="flex items-center gap-2 bg-emerald-50 p-3 rounded-xl">
                    <input type="checkbox" id="scheduleNotify" checked class="w-5 h-5 text-emerald-500 rounded">
                    <label for="scheduleNotify" class="text-sm text-gray-700 font-medium">ğŸ”” Kirim notifikasi ke semua user</label>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('createScheduleModal')" class="flex-1 py-2.5 border border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50 transition-colors">Batal</button>
                <button onclick="createSchedule()" class="flex-1 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all">Tambah</button>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div id="userDetailModal" class="fixed inset-0 bg-black/50 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full overflow-hidden scale-in">
            <div class="h-24 bg-gradient-to-br from-emerald-400 to-teal-500"></div>
            <div class="px-6 pb-6 -mt-12">
                <div class="text-center mb-4">
                    <img id="userDetailPhoto" src="" alt="" class="w-24 h-24 rounded-full object-cover mx-auto border-4 border-white shadow-xl mb-3">
                    <h3 id="userDetailName" class="text-xl font-bold text-gray-800"></h3>
                    <p id="userDetailToken" class="text-sm text-gray-400 font-mono mt-1"></p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-gray-500">Jenis Kelamin</span>
                        <span id="userDetailGender" class="font-medium text-gray-800">-</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-gray-500">WhatsApp</span>
                        <span id="userDetailPhone" class="font-medium text-gray-800">-</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-gray-500">Membership</span>
                        <span id="userDetailMembership" class="font-medium text-emerald-600">-</span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span class="text-gray-500">Device ID</span>
                        <span id="userDetailDevice" class="font-mono text-xs text-gray-400 truncate max-w-[150px]">-</span>
                    </div>
                </div>
                <button onclick="closeModal('userDetailModal')" class="w-full mt-4 py-2.5 border border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50 transition-colors">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-white rounded-2xl shadow-2xl p-4 flex items-center gap-3 z-[60] transform translate-x-full transition-all duration-300 max-w-sm border border-gray-100">
        <div id="toastIcon" class="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0"></div>
        <div class="flex-1 min-w-0">
            <p id="toastTitle" class="font-bold text-gray-800"></p>
            <p id="toastMessage" class="text-sm text-gray-500 truncate"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDMQ961-vifb3R-Gurla3LbLM_489aHkHs-g",
            authDomain: "live2ke2.firebaseapp.com",
            projectId: "live2ke2",
            storageBucket: "live2ke2.firebasestorage.app",
            messagingSenderId: "861176752510",
            appId: "1:861176752510:web:0e1ee4e2d7f96c0b5dab2f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // WebRTC Config
        const servers = { 
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ], 
            iceCandidatePoolSize: 10 
        };

        // ==================== STATE ====================
        let localStream = null;
        let peerConnections = {};
        let currentRoomId = null;
        let isBroadcasting = false;
        let broadcastSource = 'screen';
        let viewerUnsubscribers = [];
        let generatedWatchTokensList = [];
        let allUsers = [];

// ==================== ADMIN CREDENTIALS ====================
// Hardcoded admin credentials (fallback jika Firebase Auth gagal)
const ADMIN_CREDENTIALS = {
    email: 'ikaxzu@kaz.id',
    password: 'ikaxzu',
    token: 'IKAXZU' // Token admin
};

// ==================== LOGIN METHOD SWITCH ====================
function switchLoginMethod(method) {
    const emailBtn = document.getElementById('loginMethodEmail');
    const tokenBtn = document.getElementById('loginMethodToken');
    const emailForm = document.getElementById('emailLoginForm');
    const tokenForm = document.getElementById('tokenLoginForm');
    
    if (method === 'email') {
        emailBtn.classList.add('bg-white', 'text-emerald-600', 'shadow-sm');
        emailBtn.classList.remove('text-gray-500');
        tokenBtn.classList.remove('bg-white', 'text-emerald-600', 'shadow-sm');
        tokenBtn.classList.add('text-gray-500');
        emailForm.classList.remove('hidden');
        tokenForm.classList.add('hidden');
    } else {
        tokenBtn.classList.add('bg-white', 'text-emerald-600', 'shadow-sm');
        tokenBtn.classList.remove('text-gray-500');
        emailBtn.classList.remove('bg-white', 'text-emerald-600', 'shadow-sm');
        emailBtn.classList.add('text-gray-500');
        tokenForm.classList.remove('hidden');
        emailForm.classList.add('hidden');
    }
}

// ==================== EMAIL LOGIN ====================
async function adminLoginEmail() {
    const email = document.getElementById('adminEmail').value.trim();
    const password = document.getElementById('adminPassword').value;
    const errorEl = document.getElementById('loginError');
    
    if (!email || !password) {
        errorEl.textContent = 'Masukkan email dan password';
        errorEl.classList.remove('hidden');
        return;
    }
    
    // Cek hardcoded credentials dulu
    if (email === ADMIN_CREDENTIALS.email && password === ADMIN_CREDENTIALS.password) {
        // Simpan session admin
        localStorage.setItem('adminSession', JSON.stringify({
            email: email,
            loginAt: Date.now(),
            method: 'credentials'
        }));
        showDashboard();
        showToast('success', 'Login Berhasil', 'Selamat datang, Admin!');
        return;
    }
    
    // Coba Firebase Auth
    try {
        await auth.signInWithEmailAndPassword(email, password);
        localStorage.setItem('adminSession', JSON.stringify({
            email: email,
            loginAt: Date.now(),
            method: 'firebase'
        }));
        showDashboard();
        showToast('success', 'Login Berhasil', 'Selamat datang, Admin!');
    } catch (e) {
        console.error('Firebase Auth Error:', e);
        errorEl.textContent = 'Email atau password salah';
        errorEl.classList.remove('hidden');
    }
}

// ==================== TOKEN LOGIN ====================
async function adminLoginToken() {
    const token = document.getElementById('adminToken').value.trim().toUpperCase();
    const errorEl = document.getElementById('tokenLoginError');
    
    if (!token) {
        errorEl.textContent = 'Masukkan token admin';
        errorEl.classList.remove('hidden');
        return;
    }
    
    // Cek hardcoded token
    if (token === ADMIN_CREDENTIALS.token) {
        localStorage.setItem('adminSession', JSON.stringify({
            token: token,
            loginAt: Date.now(),
            method: 'token'
        }));
        showDashboard();
        showToast('success', 'Login Berhasil', 'Selamat datang, Admin!');
        return;
    }
    
    // Cek token di Firestore
    try {
        const tokenDoc = await db.collection('adminTokens').doc(token).get();
        if (tokenDoc.exists) {
            localStorage.setItem('adminSession', JSON.stringify({
                token: token,
                loginAt: Date.now(),
                method: 'firestore'
            }));
            showDashboard();
            showToast('success', 'Login Berhasil', 'Selamat datang, Admin!');
        } else {
            errorEl.textContent = 'Token tidak valid';
            errorEl.classList.remove('hidden');
        }
    } catch (e) {
        console.error('Token check error:', e);
        errorEl.textContent = 'Token tidak valid';
        errorEl.classList.remove('hidden');
    }
}

// ==================== LOGOUT ====================
function adminLogout() {
    if (isBroadcasting) stopBroadcast();
    
    // Clear session
    localStorage.removeItem('adminSession');
    
    // Sign out from Firebase if logged in
    auth.signOut().catch(() => {});
    
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('adminDashboard').classList.add('hidden');
    showToast('info', 'Logout', 'Anda telah keluar');
}

// ==================== CHECK SESSION ON LOAD ====================
function checkAdminSession() {
    const session = JSON.parse(localStorage.getItem('adminSession') || 'null');
    
    if (session && session.loginAt) {
        // Session valid for 24 hours
        const sessionAge = Date.now() - session.loginAt;
        const maxAge = 24 * 60 * 60 * 1000; // 24 jam
        
        if (sessionAge < maxAge) {
            showDashboard();
            return;
        } else {
            // Session expired
            localStorage.removeItem('adminSession');
        }
    }
    
    // Cek Firebase Auth state juga
    auth.onAuthStateChanged(user => {
        if (user) {
            localStorage.setItem('adminSession', JSON.stringify({
                email: user.email,
                loginAt: Date.now(),
                method: 'firebase'
            }));
            showDashboard();
        }
    });
}

// ==================== SHOW DASHBOARD ====================
function showDashboard() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('adminDashboard').classList.remove('hidden');
    
    const session = JSON.parse(localStorage.getItem('adminSession') || '{}');
    document.getElementById('adminEmailDisplay').textContent = session.email || session.token || 'Admin';
    
    // Load all data
    loadRooms();
    loadMembershipTokens();
    loadWatchTokens();
    loadMembers();
    loadSchedules();
    loadNotificationHistory();
    loadUsers();
}

// ==================== INITIALIZE ====================
document.addEventListener('DOMContentLoaded', () => {
    checkAdminSession();
});

        // ==================== SECTION NAVIGATION ====================
        function showSection(section) {
            const sections = ['broadcast', 'rooms', 'tokens', 'lineup', 'schedules', 'notifications', 'users', 'chat'];
            sections.forEach(s => {
                const sectionEl = document.getElementById('section' + s.charAt(0).toUpperCase() + s.slice(1));
                const tabEl = document.getElementById('tab' + s.charAt(0).toUpperCase() + s.slice(1));
                
                if (s === section) {
                    sectionEl?.classList.remove('hidden');
                    tabEl?.classList.add('tab-active');
                    tabEl?.classList.remove('text-gray-500', 'hover:bg-gray-100');
                } else {
                    sectionEl?.classList.add('hidden');
                    tabEl?.classList.remove('tab-active');
                    tabEl?.classList.add('text-gray-500', 'hover:bg-gray-100');
                }
            });
        }

        // ==================== MODAL FUNCTIONS ====================
        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('flex');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }

        // ==================== BROADCAST ====================
        function selectSource(source) {
            broadcastSource = source;
            const screenBtn = document.getElementById('sourceScreen');
            const cameraBtn = document.getElementById('sourceCamera');
            
            if (source === 'screen') {
                screenBtn.className = 'flex-1 px-4 py-3 border-2 border-emerald-500 bg-emerald-50 text-emerald-700 rounded-xl font-semibold transition-all flex items-center justify-center gap-2';
                cameraBtn.className = 'flex-1 px-4 py-3 border-2 border-gray-200 text-gray-600 rounded-xl font-semibold hover:border-gray-300 transition-all flex items-center justify-center gap-2';
            } else {
                cameraBtn.className = 'flex-1 px-4 py-3 border-2 border-emerald-500 bg-emerald-50 text-emerald-700 rounded-xl font-semibold transition-all flex items-center justify-center gap-2';
                screenBtn.className = 'flex-1 px-4 py-3 border-2 border-gray-200 text-gray-600 rounded-xl font-semibold hover:border-gray-300 transition-all flex items-center justify-center gap-2';
            }
        }

        async function startBroadcast() {
            const roomId = document.getElementById('broadcastRoomSelect').value;
            if (!roomId) {
                showToast('error', 'Error', 'Pilih room terlebih dahulu');
                return;
            }

            try {
                if (broadcastSource === 'screen') {
                    localStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 30 } },
                        audio: true
                    });
                } else {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: { ideal: 1280 }, height: { ideal: 720 } },
                        audio: true
                    });
                }

                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('previewOverlay').classList.add('hidden');
                document.getElementById('liveIndicator').classList.remove('hidden');
                document.getElementById('liveIndicator').classList.add('flex');
                document.getElementById('viewersList').classList.remove('hidden');

                currentRoomId = roomId;
                isBroadcasting = true;

                await db.collection('rooms').doc(roomId).update({
                    isLive: true,
                    startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    viewerCount: 0
                });

                const pc = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                await db.collection('rooms').doc(roomId).update({
                    offer: { type: offer.type, sdp: offer.sdp }
                });

                listenForViewers(roomId, pc);

                localStream.getVideoTracks()[0].onended = () => stopBroadcast();

                document.getElementById('startBroadcastBtn').classList.add('hidden');
                document.getElementById('stopBroadcastBtn').classList.remove('hidden');
                document.getElementById('broadcastDot').className = 'w-3 h-3 bg-red-500 rounded-full pulse-live';
                document.getElementById('broadcastStatusText').textContent = 'LIVE';
                document.getElementById('broadcastStatusText').className = 'text-red-600 font-bold';

                showToast('success', 'Live!', 'Broadcast dimulai');
            } catch (error) {
                showToast('error', 'Error', error.message);
            }
        }

        async function stopBroadcast() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};
            viewerUnsubscribers.forEach(unsub => unsub());
            viewerUnsubscribers = [];

            if (currentRoomId) {
                await db.collection('rooms').doc(currentRoomId).update({
                    isLive: false,
                    offer: firebase.firestore.FieldValue.delete()
                });

                const viewers = await db.collection('rooms').doc(currentRoomId).collection('viewers').get();
                const batch = db.batch();
                viewers.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }

            currentRoomId = null;
            isBroadcasting = false;

            document.getElementById('localVideo').srcObject = null;
            document.getElementById('previewOverlay').classList.remove('hidden');
            document.getElementById('liveIndicator').classList.add('hidden');
            document.getElementById('viewersList').classList.add('hidden');
            document.getElementById('startBroadcastBtn').classList.remove('hidden');
            document.getElementById('stopBroadcastBtn').classList.add('hidden');
            document.getElementById('broadcastDot').className = 'w-3 h-3 bg-gray-400 rounded-full';
            document.getElementById('broadcastStatusText').textContent = 'Tidak Aktif';
            document.getElementById('broadcastStatusText').className = 'text-gray-600 font-medium';

            showToast('info', 'Stopped', 'Broadcast dihentikan');
        }

        function listenForViewers(roomId, broadcasterPc) {
            const unsub = db.collection('rooms').doc(roomId).collection('viewers').onSnapshot(async snapshot => {
                snapshot.docChanges().forEach(async change => {
                    const viewerId = change.doc.id;
                    const viewerData = change.doc.data();

                    if (change.type === 'added' && viewerData.answer) {
                        try {
                            const pc = new RTCPeerConnection(servers);
                            peerConnections[viewerId] = pc;

                            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

                            const offer = await pc.createOffer();
                            await pc.setLocalDescription(offer);
                            await pc.setRemoteDescription(new RTCSessionDescription(viewerData.answer));

                            db.collection('rooms').doc(roomId)
                                .collection('viewerCandidates').doc(viewerId)
                                .collection('candidates').onSnapshot(candidateSnapshot => {
                                    candidateSnapshot.docChanges().forEach(async candidateChange => {
                                        if (candidateChange.type === 'added') {
                                            try { await pc.addIceCandidate(new RTCIceCandidate(candidateChange.doc.data())); } catch (e) {}
                                        }
                                    });
                                });

                            pc.onicecandidate = async event => {
                                if (event.candidate) {
                                    await db.collection('rooms').doc(roomId)
                                        .collection('broadcasterCandidates').doc(viewerId)
                                        .collection('candidates').add(event.candidate.toJSON());
                                }
                            };

                            updateViewersList();
                        } catch (e) {
                            console.error('Error handling viewer:', e);
                        }
                    } else if (change.type === 'removed') {
                        if (peerConnections[viewerId]) {
                            peerConnections[viewerId].close();
                            delete peerConnections[viewerId];
                        }
                        updateViewersList();
                    }
                });
            });
            viewerUnsubscribers.push(unsub);
        }

        function updateViewersList() {
            document.getElementById('viewerCountAdmin').textContent = Object.keys(peerConnections).length;
        }

        // ==================== ROOMS ====================
        function loadRooms() {
            db.collection('rooms').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                const list = document.getElementById('roomsList');
                const broadcastSelect = document.getElementById('broadcastRoomSelect');
                const watchSelect = document.getElementById('watchTokenRoom');
                const chatSelect = document.getElementById('chatRoomSelect');

                broadcastSelect.innerHTML = '<option value="">-- Pilih Room --</option>';
                watchSelect.innerHTML = '<option value="">Semua Room</option>';
                chatSelect.innerHTML = '<option value="">-- Pilih Room --</option>';

                if (snapshot.empty) {
                    list.innerHTML = '<div class="col-span-full bg-white rounded-2xl p-8 border-2 border-dashed border-gray-200 text-center text-gray-400"><span class="text-4xl block mb-2">ğŸ </span>Belum ada room</div>';
                    return;
                }

                list.innerHTML = '';

                snapshot.forEach(doc => {
                    const room = doc.data();
                    const id = doc.id;

                    const option = `<option value="${id}">${room.title || 'Untitled'}</option>`;
                    broadcastSelect.innerHTML += option;
                    watchSelect.innerHTML += option;
                    chatSelect.innerHTML += option;

                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-2xl border border-gray-100 overflow-hidden card-hover';
                    card.innerHTML = `
                        <div class="aspect-video bg-gray-100 relative">
                            <img src="${room.thumbnail || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=400'}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/400x225?text=Room'">
                            ${room.isLive ? '<div class="absolute top-2 left-2 px-2 py-1 bg-red-500 text-white text-xs font-bold rounded flex items-center gap-1"><span class="w-1.5 h-1.5 bg-white rounded-full pulse-live"></span>LIVE</div>' : ''}
                            <div class="absolute bottom-2 right-2 px-2 py-1 bg-black/60 text-white text-xs rounded-lg font-medium">${room.viewerCount || 0} viewers</div>
                        </div>
                        <div class="p-4">
                            <h4 class="font-bold text-gray-800 truncate">${room.title || 'Untitled'}</h4>
                            <p class="text-gray-400 text-sm truncate">${room.subtitle || '-'}</p>
                            <div class="flex justify-end mt-3">
                                <button onclick="deleteRoom('${id}')" class="p-2 hover:bg-red-50 rounded-lg transition-colors">
                                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        async function createRoom() {
            const title = document.getElementById('roomTitle').value.trim();
            if (!title) { showToast('error', 'Error', 'Judul wajib diisi'); return; }

            await db.collection('rooms').add({
                title,
                subtitle: document.getElementById('roomSubtitle').value.trim(),
                description: document.getElementById('roomDescription').value.trim(),
                thumbnail: document.getElementById('roomThumbnail').value.trim(),
                host: document.getElementById('roomHost').value.trim() || 'Admin',
                isLive: false,
                viewerCount: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            closeModal('createRoomModal');
            ['roomTitle', 'roomSubtitle', 'roomDescription', 'roomThumbnail', 'roomHost'].forEach(id => document.getElementById(id).value = '');
            showToast('success', 'Berhasil', 'Room dibuat');
        }

        async function deleteRoom(id) {
            if (confirm('Hapus room ini?')) {
                await db.collection('rooms').doc(id).delete();
                showToast('success', 'Dihapus', 'Room berhasil dihapus');
            }
        }

        // ==================== TOKENS ====================
        function generateToken() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let token = '';
            for (let i = 0; i < 8; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return token;
        }

        function copyToken(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text);
            showToast('success', 'Copied!', 'Token disalin ke clipboard');
        }

        function copyAllWatchTokens() {
            const text = generatedWatchTokensList.join('\n');
            navigator.clipboard.writeText(text);
            showToast('success', 'Copied!', 'Semua token disalin');
        }

        function loadMembershipTokens() {
            db.collection('membershipTokens').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                const list = document.getElementById('membershipTokensList');
                if (snapshot.empty) { list.innerHTML = '<div class="text-center py-8 text-gray-400">Belum ada token</div>'; return; }

                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const id = doc.id;
                    const exp = t.expiresAt?.toDate();
                    const isExp = exp && exp < new Date();

                    const card = document.createElement('div');
                    card.className = `p-3 rounded-xl border ${isExp ? 'bg-red-50 border-red-100' : t.deviceId ? 'bg-amber-50 border-amber-100' : 'bg-emerald-50 border-emerald-100'}`;
                    card.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <p class="font-mono text-sm font-bold text-gray-800 truncate">${id}</p>
                                <p class="text-xs text-gray-500">${t.name || '-'} â€¢ ${t.months || 1} bulan</p>
                                <span class="text-xs ${isExp ? 'text-red-600' : t.deviceId ? 'text-amber-600' : 'text-emerald-600'} font-medium">${isExp ? 'âŒ Kadaluarsa' : t.deviceId ? 'ğŸ“± Terpakai' : 'âœ… Aktif'}</span>
                            </div>
                            <button onclick="deleteMembershipToken('${id}')" class="p-2 hover:bg-red-100 rounded-lg transition-colors">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        async function createMembershipToken() {
            const name = document.getElementById('membershipName').value.trim();
            const months = parseInt(document.getElementById('membershipMonths').value);

            if (!name) { showToast('error', 'Error', 'Nama wajib diisi'); return; }

            const token = generateToken();
            const exp = new Date();
            exp.setMonth(exp.getMonth() + months);

            await db.collection('membershipTokens').doc(token).set({
                name,
                months,
                expiresAt: firebase.firestore.Timestamp.fromDate(exp),
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                deviceId: null
            });

            document.getElementById('membershipTokenValue').textContent = token;
            document.getElementById('generatedMembershipToken').classList.remove('hidden');
            showToast('success', 'Berhasil', 'Token membership dibuat');
        }

        async function deleteMembershipToken(id) {
            if (confirm('Hapus token?')) await db.collection('membershipTokens').doc(id).delete();
        }

        function loadWatchTokens() {
            db.collection('watchTokens').orderBy('createdAt', 'desc').limit(50).onSnapshot(snapshot => {
                const list = document.getElementById('watchTokensList');
                if (snapshot.empty) { list.innerHTML = '<div class="text-center py-8 text-gray-400">Belum ada token</div>'; return; }

                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const id = doc.id;

                    const card = document.createElement('div');
                    card.className = `p-3 rounded-xl border ${t.used ? 'bg-gray-50 border-gray-100' : 'bg-blue-50 border-blue-100'}`;
                    card.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-mono text-sm font-bold text-gray-800">${id}</p>
                                <span class="text-xs ${t.used ? 'text-gray-500' : 'text-blue-600'} font-medium">${t.used ? 'ğŸ“± Terpakai' : 'âœ… Tersedia'}</span>
                            </div>
                            <button onclick="deleteWatchToken('${id}')" class="p-2 hover:bg-red-100 rounded-lg transition-colors">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        async function createWatchTokens() {
            const roomId = document.getElementById('watchTokenRoom').value;
            const count = parseInt(document.getElementById('watchTokenCount').value) || 1;

            generatedWatchTokensList = [];
            const batch = db.batch();

            for (let i = 0; i < count; i++) {
                const token = generateToken();
                batch.set(db.collection('watchTokens').doc(token), {
                    roomId: roomId || null,
                    used: false,
                    deviceId: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                generatedWatchTokensList.push(token);
            }

            await batch.commit();

            document.getElementById('watchTokensValues').innerHTML = generatedWatchTokensList.map(t => `<div class="text-blue-700 py-1">${t}</div>`).join('');
            document.getElementById('generatedWatchTokens').classList.remove('hidden');
            showToast('success', 'Berhasil', `${count} token dibuat`);
        }

        async function deleteWatchToken(id) {
            if (confirm('Hapus token?')) await db.collection('watchTokens').doc(id).delete();
        }

        // ==================== MEMBERS (LINEUP) - UPDATED ====================
        function loadMembers() {
            db.collection('members').orderBy('order', 'asc').onSnapshot(snapshot => {
                const list = document.getElementById('membersList');

                if (snapshot.empty) {
                    list.innerHTML = '<div class="col-span-full bg-white rounded-2xl p-8 border-2 border-dashed border-gray-200 text-center text-gray-400"><span class="text-4xl block mb-2">ğŸ‘¥</span>Belum ada member</div>';
                    return;
                }

                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const m = doc.data();
                    const id = doc.id;

                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-2xl border border-gray-100 p-4 text-center card-hover';
                    card.innerHTML = `
                        <div class="relative inline-block mb-3">
                            <img src="${m.photo || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(m.name) + '&background=10b981&color=fff'}" 
                                class="w-20 h-20 rounded-full object-cover mx-auto border-2 ${m.isOnline ? 'border-emerald-200' : 'border-gray-100'} shadow-lg" 
                                onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(m.name)}&background=10b981&color=fff'">
                            <span class="absolute bottom-0 right-0 w-5 h-5 ${m.isOnline ? 'bg-emerald-500' : 'bg-gray-400'} rounded-full border-2 border-white"></span>
                        </div>
                        <h4 class="font-bold text-gray-800 truncate">${m.name}</h4>
                        <p class="text-xs text-gray-400 truncate mb-2">${m.info || '-'}</p>
                        
                        <!-- Social Icons -->
                        <div class="flex justify-center gap-1 mb-2">
                            ${m.instagram ? `<a href="https://instagram.com/${m.instagram}" target="_blank" class="w-6 h-6 bg-pink-100 rounded-full flex items-center justify-center text-xs hover:bg-pink-200 transition-colors">ğŸ“¸</a>` : ''}
                            ${m.twitter ? `<a href="https://twitter.com/${m.twitter}" target="_blank" class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center text-xs hover:bg-blue-200 transition-colors">ğŸ¦</a>` : ''}
                            ${m.tiktok ? `<a href="https://tiktok.com/@${m.tiktok}" target="_blank" class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-xs hover:bg-gray-200 transition-colors">ğŸµ</a>` : ''}
                        </div>

                        <!-- Stats -->
                        <div class="flex justify-center gap-3 text-xs text-gray-400 mb-3">
                            <span>â¤ï¸ ${m.followers || 0}</span>
                            <span>ğŸ¬ ${m.lives || 0}</span>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-center gap-1">
                            <button onclick="toggleMemberOnline('${id}', ${!m.isOnline})" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Toggle Online">
                                <svg class="w-4 h-4 ${m.isOnline ? 'text-emerald-500' : 'text-gray-400'}" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            </button>
                            <button onclick="editMember('${id}')" class="p-2 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            </button>
                            <button onclick="deleteMember('${id}')" class="p-2 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        // ==================== CREATE MEMBER (UPDATED) ====================
        async function createMember() {
            const name = document.getElementById('newMemberName').value.trim();
            if (!name) { 
                showToast('error', 'Error', 'Nama wajib diisi'); 
                return; 
            }

            const memberData = {
                name,
                photo: document.getElementById('newMemberPhoto').value.trim(),
                info: document.getElementById('newMemberInfo').value.trim(),
                order: parseInt(document.getElementById('newMemberOrder').value) || 1,
                isOnline: document.getElementById('newMemberOnline').checked,
                // Social Media
                instagram: document.getElementById('newMemberInstagram').value.trim(),
                twitter: document.getElementById('newMemberTwitter').value.trim(),
                tiktok: document.getElementById('newMemberTiktok').value.trim(),
                // Stats
                followers: parseInt(document.getElementById('newMemberFollowers').value) || 0,
                lives: parseInt(document.getElementById('newMemberLives').value) || 0,
                // Metadata
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('members').add(memberData);

                closeModal('createMemberModal');
                
                // Reset form
                ['newMemberName', 'newMemberPhoto', 'newMemberInfo', 'newMemberInstagram', 'newMemberTwitter', 'newMemberTiktok'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                document.getElementById('newMemberOrder').value = '1';
                document.getElementById('newMemberFollowers').value = '0';
                document.getElementById('newMemberLives').value = '0';
                document.getElementById('newMemberOnline').checked = false;
                
                showToast('success', 'Berhasil', 'Member ditambahkan ke lineup');
            } catch (error) {
                console.error('Create member error:', error);
                showToast('error', 'Error', 'Gagal menambahkan member');
            }
        }

        function editMember(id) {
            showToast('info', 'Edit Member', 'Fitur edit akan segera hadir. Hapus dan buat ulang untuk sementara.');
        }

        async function toggleMemberOnline(id, isOnline) {
            await db.collection('members').doc(id).update({ isOnline });
        }

        async function deleteMember(id) {
            if (confirm('Hapus member?')) await db.collection('members').doc(id).delete();
        }

        // ==================== SCHEDULES - UPDATED ====================
        function loadSchedules() {
            db.collection('schedules').orderBy('date', 'asc').onSnapshot(snapshot => {
                const list = document.getElementById('schedulesList');

                if (snapshot.empty) {
                    list.innerHTML = '<div class="bg-white rounded-2xl p-8 border-2 border-dashed border-gray-200 text-center text-gray-400"><span class="text-4xl block mb-2">ğŸ“…</span>Belum ada jadwal</div>';
                    return;
                }

                list.innerHTML = '';
                const now = new Date();

                snapshot.forEach(doc => {
                    const s = doc.data();
                    const id = doc.id;
                    const date = s.date?.toDate();
                    const isPast = date && date < now;

                    const typeColors = {
                        live: { bg: 'bg-red-50', border: 'border-red-100', text: 'text-red-600' },
                        event: { bg: 'bg-purple-50', border: 'border-purple-100', text: 'text-purple-600' },
                        theater: { bg: 'bg-amber-50', border: 'border-amber-100', text: 'text-amber-600' }
                    };
                    const color = typeColors[s.type] || typeColors.live;

                    const card = document.createElement('div');
                    card.className = `bg-white rounded-xl p-4 flex items-center gap-4 border ${isPast ? 'border-gray-100 opacity-60' : 'border-gray-100'} card-hover`;
                    card.innerHTML = `
                        <div class="w-14 h-14 ${color.bg} rounded-xl flex flex-col items-center justify-center flex-shrink-0">
                            <span class="text-2xl">${s.emoji || 'ğŸ“…'}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-bold text-gray-800 truncate">${s.title || 'Untitled'}</h4>
                                <span class="px-2 py-0.5 ${color.bg} ${color.text} text-xs rounded-full font-medium capitalize">${s.type || 'live'}</span>
                            </div>
                            <p class="text-sm text-gray-500">${date ? date.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }) : '-'} â€¢ ${date ? date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '--:--'} WIB</p>
                            <p class="text-xs text-gray-400 truncate">${s.description || '-'}</p>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="px-2 py-1 ${isPast ? 'bg-gray-100 text-gray-500' : 'bg-emerald-100 text-emerald-700'} text-xs rounded-full font-medium">
                                ${isPast ? 'âœ“ Selesai' : 'â° Upcoming'}
                            </span>
                            <button onclick="deleteSchedule('${id}')" class="p-2 hover:bg-red-50 rounded-lg transition-colors">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        // ==================== CREATE SCHEDULE (UPDATED) ====================
        async function createSchedule() {
            const title = document.getElementById('scheduleTitle').value.trim();
            const dateStr = document.getElementById('scheduleDate').value;
            const shouldNotify = document.getElementById('scheduleNotify').checked;

            if (!title || !dateStr) {
                showToast('error', 'Error', 'Judul dan tanggal wajib diisi');
                return;
            }

            const date = new Date(dateStr);
            const scheduleType = document.querySelector('input[name="scheduleType"]:checked')?.value || 'live';
            
            // Emoji based on type
            const typeEmojis = {
                live: 'ğŸ¬',
                event: 'ğŸ‰',
                theater: 'ğŸ­'
            };

            const scheduleData = {
                title,
                date: firebase.firestore.Timestamp.fromDate(date),
                description: document.getElementById('scheduleDescription').value.trim(),
                thumbnail: document.getElementById('scheduleThumbnail').value.trim(),
                type: scheduleType,
                emoji: typeEmojis[scheduleType],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('schedules').add(scheduleData);

                // Send notification if checked
                if (shouldNotify) {
                    await db.collection('notifications').add({
                        type: 'schedule',
                        title: `ğŸ“… Jadwal Baru: ${title}`,
                        message: `${date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })} pukul ${date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })} WIB`,
                        scheduleType: scheduleType,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                closeModal('createScheduleModal');
                
                // Reset form
                document.getElementById('scheduleTitle').value = '';
                document.getElementById('scheduleDate').value = '';
                document.getElementById('scheduleDescription').value = '';
                document.getElementById('scheduleThumbnail').value = '';
                document.querySelector('input[name="scheduleType"][value="live"]').checked = true;
                
                showToast('success', 'Berhasil', 'Jadwal ditambahkan' + (shouldNotify ? ' & notifikasi terkirim' : ''));
            } catch (error) {
                console.error('Create schedule error:', error);
                showToast('error', 'Error', 'Gagal menambahkan jadwal');
            }
        }

        async function deleteSchedule(id) {
            if (confirm('Hapus jadwal?')) await db.collection('schedules').doc(id).delete();
        }

        // ==================== NOTIFICATIONS ====================
        function loadNotificationHistory() {
            db.collection('notifications').orderBy('createdAt', 'desc').limit(20).onSnapshot(snapshot => {
                const list = document.getElementById('notificationHistory');

                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center py-8 text-gray-400">Belum ada notifikasi</div>';
                    return;
                }

                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const n = doc.data();
                    const time = n.createdAt?.toDate();

                    const typeIcons = { info: 'ğŸ“¢', schedule: 'ğŸ“…', live: 'ğŸ”´', announcement: 'ğŸ“£' };

                    const card = document.createElement('div');
                    card.className = 'p-3 bg-gray-50 rounded-xl';
                    card.innerHTML = `
                        <div class="flex items-start gap-3">
                            <span class="text-xl">${typeIcons[n.type] || 'ğŸ“¢'}</span>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-800 text-sm">${n.title}</p>
                                <p class="text-xs text-gray-500">${n.message}</p>
                                <p class="text-xs text-gray-400 mt-1">${time ? time.toLocaleString('id-ID') : '-'}</p>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        async function sendNotification() {
            const type = document.getElementById('notifType').value;
            const title = document.getElementById('notifTitle').value.trim();
            const message = document.getElementById('notifMessage').value.trim();

            if (!title || !message) {
                showToast('error', 'Error', 'Judul dan pesan wajib diisi');
                return;
            }

            await db.collection('notifications').add({
                type,
                title,
                message,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
            showToast('success', 'Terkirim!', 'Notifikasi berhasil dikirim');
        }

        // ==================== USERS ====================
        function loadUsers() {
            db.collection('membershipTokens').onSnapshot(snapshot => {
                allUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.name) {
                        allUsers.push({ token: doc.id, ...data });
                    }
                });
            });
        }

        function searchUsers() {
            const query = document.getElementById('searchUserInput').value.toLowerCase().trim();
            const container = document.getElementById('userSearchResults');

            if (!query) {
                container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400"><span class="text-4xl block mb-2">ğŸ”</span>Ketik nama untuk mencari user</div>';
                return;
            }

            const filtered = allUsers.filter(u => u.name && u.name.toLowerCase().includes(query));

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-8 text-gray-400"><span class="text-4xl block mb-2">ğŸ˜•</span>Tidak ditemukan user dengan nama "${query}"</div>`;
                return;
            }

            container.innerHTML = '';
            filtered.forEach(user => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl border border-gray-100 p-4 flex items-center gap-4 cursor-pointer hover:shadow-md transition-all';
                card.onclick = () => showUserDetail(user);

                const exp = user.expiresAt?.toDate();
                const isActive = exp && exp > new Date();

                card.innerHTML = `
                    <img src="${user.photo || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.name) + '&background=10b981&color=fff'}" class="w-14 h-14 rounded-full object-cover border-2 border-gray-100" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=10b981&color=fff'">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-gray-800 truncate">${user.name}</h4>
                        <p class="text-xs font-mono text-gray-400">${user.token}</p>
                        <span class="text-xs ${isActive ? 'text-emerald-600' : 'text-red-500'} font-medium">${isActive ? 'âœ… Aktif' : 'âŒ Tidak Aktif'}</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                `;
                container.appendChild(card);
            });
        }

        function showUserDetail(user) {
            document.getElementById('userDetailPhoto').src = user.photo || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.name) + '&background=10b981&color=fff&size=200';
            document.getElementById('userDetailName').textContent = user.name || '-';
            document.getElementById('userDetailToken').textContent = user.token || '-';
            document.getElementById('userDetailGender').textContent = user.gender || '-';
            document.getElementById('userDetailPhone').textContent = user.phone || '-';
            
            const exp = user.expiresAt?.toDate();
            const isActive = exp && exp > new Date();
            document.getElementById('userDetailMembership').textContent = isActive ? `Aktif hingga ${exp.toLocaleDateString('id-ID')}` : 'Tidak Aktif';
            document.getElementById('userDetailMembership').className = `font-medium ${isActive ? 'text-emerald-600' : 'text-red-500'}`;
            
            document.getElementById('userDetailDevice').textContent = user.deviceId || '-';

            showModal('userDetailModal');
        }

        // ==================== CHAT ====================
        function loadChatMessages() {
            const roomId = document.getElementById('chatRoomSelect').value;
            if (!roomId) {
                document.getElementById('chatContainer').classList.add('hidden');
                return;
            }

            document.getElementById('chatContainer').classList.remove('hidden');

            db.collection('rooms').doc(roomId).collection('messages')
                .orderBy('timestamp', 'asc')
                .limitToLast(100)
                .onSnapshot(snapshot => {
                    const container = document.getElementById('adminChatMessages');
                    container.innerHTML = '';

                    if (snapshot.empty) {
                        container.innerHTML = '<div class="text-center py-8 text-gray-400">Belum ada pesan</div>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const time = msg.timestamp?.toDate()?.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) || '';

                        const bubble = document.createElement('div');
                        bubble.className = `p-3 rounded-xl ${msg.isAdmin ? 'bg-emerald-50 border border-emerald-100' : 'bg-white border border-gray-100'}`;
                        bubble.innerHTML = `
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-sm ${msg.isAdmin ? 'text-emerald-700' : 'text-gray-700'}">${msg.sender || 'Anonymous'}</span>
                                ${msg.isAdmin ? '<span class="px-1.5 py-0.5 bg-emerald-500 text-white text-xs rounded font-medium">Admin</span>' : ''}
                                <span class="text-xs text-gray-400">${time}</span>
                            </div>
                            <p class="text-sm text-gray-600">${msg.text}</p>
                        `;
                        container.appendChild(bubble);
                    });

                    container.scrollTop = container.scrollHeight;
                });
        }

        async function sendAdminMessage() {
            const roomId = document.getElementById('chatRoomSelect').value;
            const input = document.getElementById('adminChatInput');
            const text = input.value.trim();

            if (!roomId || !text) return;

            await db.collection('rooms').doc(roomId).collection('messages').add({
                text,
                sender: 'Admin',
                isAdmin: true,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            input.value = '';
        }

        // ==================== TOAST ====================
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');

            const icons = {
                success: { bg: 'bg-emerald-100', emoji: 'âœ…' },
                error: { bg: 'bg-red-100', emoji: 'âŒ' },
                info: { bg: 'bg-blue-100', emoji: 'â„¹ï¸' }
            };

            const icon = icons[type] || icons.info;
            toastIcon.className = `w-12 h-12 rounded-xl flex items-center justify-center ${icon.bg}`;
            toastIcon.innerHTML = `<span class="text-2xl">${icon.emoji}</span>`;
            toastTitle.textContent = title;
            toastMessage.textContent = message;

            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 4000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (isBroadcasting) stopBroadcast();
        });
    </script>
</body>
</html>