<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Transaksi | Ikazz - 48</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: '#E3F0E9',
                        blush: '#FFE5E5',
                        peach: '#FFE8D9',
                        dark: '#1C1C1E',
                        secondary: '#8E8E93',
                        divider: '#E5E5E7'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-pending { background: #FEF3C7; color: #92400E; }
        .status-success { background: #D1FAE5; color: #065F46; }
        .status-confirmed { background: #D1FAE5; color: #065F46; }
        .status-rejected { background: #FEE2E2; color: #991B1B; }
        .status-completed { background: #DBEAFE; color: #1E40AF; }
        .status-cancelled { background: #F3F4F6; color: #4B5563; }
        
        .token-item {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .token-item:hover {
            border-color: #10b981;
            transform: scale(1.02);
        }
        
        .countdown-timer {
            font-family: 'Inter', monospace;
            background: linear-gradient(135deg, #667eea 0%, #10b981 100%);
        }
    </style>
</head>
<body class="bg-[#F5F7FA] min-h-screen pb-24">
    <!-- Header -->
    <header class="sticky top-0 z-40 glass border-b border-divider/30">
        <div class="max-w-4xl mx-auto px-6 py-4">
            <div class="flex items-center gap-4">
                <a href="shop.html" class="w-10 h-10 bg-gray-100 rounded-2xl flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <div>
                    <h1 class="text-xl font-semibold text-dark">Riwayat Transaksi</h1>
                    <p class="text-secondary text-sm">Token akan otomatis terhapus setelah 7 hari</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-6 py-6">
        <!-- Countdown Info -->
        <div class="countdown-timer rounded-2xl p-4 mb-6 text-white animate-fadeInUp">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-white/80 text-sm">Token akan otomatis terhapus dalam:</p>
                        <p id="globalCountdown" class="text-2xl font-bold">7 hari 0 jam</p>
                    </div>
                </div>
                <button onclick="manualCleanup()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-xl text-sm font-medium transition-colors">
                    Hapus Semua
                </button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-white rounded-2xl p-4 mb-6 shadow-sm animate-fadeInUp">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-medium text-dark">Filter Status</h3>
                <button onclick="clearFilter()" class="text-xs text-emerald-600 font-medium hover:text-emerald-700">Reset</button>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="filterTransactions('all')" class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all" data-filter="all" style="background: #059669; color: white;">Semua</button>
                <button onclick="filterTransactions('pending')" class="filter-btn px-4 py-2 rounded-xl text-sm font-medium bg-yellow-50 text-yellow-700 hover:bg-yellow-100">‚è≥ Menunggu</button>
                <button onclick="filterTransactions('confirmed')" class="filter-btn px-4 py-2 rounded-xl text-sm font-medium bg-emerald-50 text-emerald-700 hover:bg-emerald-100">‚úÖ Berhasil</button>
                <button onclick="filterTransactions('rejected')" class="filter-btn px-4 py-2 rounded-xl text-sm font-medium bg-red-50 text-red-700 hover:bg-red-100">‚ùå Ditolak</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 animate-fadeInUp">
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <p class="text-secondary text-xs mb-1">Total Transaksi</p>
                <p class="text-2xl font-bold text-dark" id="totalCount">0</p>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <p class="text-secondary text-xs mb-1">Total Pengeluaran</p>
                <p class="text-2xl font-bold text-emerald-600" id="totalSpent">Rp 0</p>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <p class="text-secondary text-xs mb-1">Token Aktif</p>
                <p class="text-2xl font-bold text-blue-600" id="activeTokens">0</p>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <p class="text-secondary text-xs mb-1">Akan Dihapus</p>
                <p class="text-2xl font-bold text-orange-600" id="expiringSoon">0</p>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-6 animate-fadeInUp">
            <div class="relative">
                <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input type="text" id="searchInput" placeholder="Cari transaksi atau token..." class="w-full pl-12 pr-4 py-3 bg-white rounded-xl border border-divider focus:outline-none focus:ring-2 focus:ring-emerald-500" onkeyup="searchTransactions()">
            </div>
        </div>

        <!-- Transactions List -->
        <div id="transactionsList" class="space-y-4 animate-fadeInUp">
            <!-- Will be filled by JavaScript -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <div class="w-24 h-24 bg-gray-100 rounded-3xl flex items-center justify-center mx-auto mb-4">
                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-dark mb-2">Belum Ada Transaksi</h3>
            <p class="text-secondary text-sm mb-6">Kamu belum melakukan transaksi apapun</p>
            <a href="shop.html" class="inline-block px-6 py-3 bg-emerald-500 text-white font-medium rounded-xl hover:bg-emerald-600 transition-colors">
                Beli Sekarang
            </a>
        </div>

        <!-- Load More Button -->
        <div id="loadMoreContainer" class="text-center mt-6 hidden">
            <button onclick="loadMoreTransactions()" class="px-6 py-3 bg-white text-emerald-600 font-medium rounded-xl hover:bg-emerald-50 transition-colors">
                Muat Lebih Banyak
            </button>
        </div>
    </main>

    <!-- Transaction Detail Modal -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="hideDetailModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto transform transition-transform duration-300 translate-y-full" id="detailModalContent">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
            
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-dark">Detail Transaksi</h3>
                <button onclick="hideDetailModal()" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div id="detailContent" class="space-y-4">
                <!-- Detail will be filled by JavaScript -->
            </div>

            <div id="detailActions" class="flex gap-3 mt-6">
                <!-- Actions will be filled by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Token Detail Modal -->
    <div id="tokenModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="hideTokenModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto transform transition-transform duration-300 translate-y-full" id="tokenModalContent">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
            
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-dark">Token Nonton</h3>
                <button onclick="hideTokenModal()" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div id="tokenDetailContent" class="space-y-4">
                <!-- Token list will be filled by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="hideConfirmDeleteModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl p-6 max-w-sm w-full mx-4 animate-fadeInUp">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-dark mb-2">Hapus Semua Riwayat?</h3>
                <p class="text-secondary text-sm">Semua transaksi dan token akan dihapus permanen dari database. Tindakan ini tidak dapat dibatalkan.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="hideConfirmDeleteModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                    Batal
                </button>
                <button onclick="deleteAllHistory()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors">
                    Hapus Semua
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-divider/30 z-40">
        <div class="max-w-lg mx-auto px-4 py-2">
            <div class="flex items-center justify-around">
                <a href="index.html" class="bottom-nav-item active flex flex-col items-center py-1 px-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </div>
                    <span class="text-xs font-medium">Home</span>
                </a>
                <a href="jadwal.html" class="bottom-nav-item flex flex-col items-center py-1 px-3 text-secondary">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <span class="text-xs font-medium">Jadwal</span>
                </a>
                <a href="shop.html" class="bottom-nav-item flex flex-col items-center py-1 px-3 text-secondary">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                    </div>
                    <span class="text-xs font-medium">Shop</span>
                </a>
                <a href="transaction.html" class="bottom-nav-item flex flex-col items-center py-1 px-3 text-secondary">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1z" />
                        </svg>
                    </div>
                    <span class="text-xs font-medium">transaction</span>
                </a>
                <a href="prof.html" class="bottom-nav-item flex flex-col items-center py-1 px-3 text-secondary">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <span class="text-xs font-medium">Profil</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- FAB Contact Admin -->
    <a href="https://wa.me/6285183885551" target="_blank" class="fixed bottom-24 right-6 w-14 h-14 bg-green-500 rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 transition-colors z-30 animate-bounce-subtle">
        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    </a>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] opacity-0 transform -translate-y-4 transition-all duration-300 pointer-events-none">
        <div class="bg-dark text-white px-6 py-3 rounded-2xl shadow-lg flex items-center gap-3">
            <span id="toastIcon"></span>
            <span id="toastMessage" class="text-sm font-medium"></span>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA9auv4Fb4qZgQmVt501XvgEL_hgHmFsjg",
            authDomain: "liveee-c493c.firebaseapp.com",
            projectId: "liveee-c493c",
            storageBucket: "liveee-c493c.firebasestorage.app",
            messagingSenderId: "359936219000",
            appId: "1:359936219000:web:ccd25480e9e7336b535a8d"
        };

        const liveConfig = {
            apiKey: "AIzaSyDMQ961-vifb3R-Gurla3LbLM_489aHkHs-g",
            authDomain: "live2ke2.firebaseapp.com",
            projectId: "live2ke2"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const liveApp = firebase.initializeApp(liveConfig, 'live');
        
        const db = app.firestore();
        const liveDb = liveApp.firestore();

        // State
        let currentUser = null;
        let allTransactions = [];
        let filteredTransactions = [];
        let displayedCount = 10;
        let currentFilter = 'all';
        let searchTerm = '';
        let cleanupInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkUserLogin();
            startAutoCleanup();
        });

        // Check User Login
        async function checkUserLogin() {
            const loginToken = localStorage.getItem('loginToken');
            if (loginToken) {
                try {
                    const tokenDoc = await db.collection('loginTokens').doc(loginToken).get();
                    if (tokenDoc.exists && tokenDoc.data().userId) {
                        const userDoc = await db.collection('users').doc(tokenDoc.data().userId).get();
                        if (userDoc.exists) {
                            currentUser = { id: tokenDoc.data().userId, ...userDoc.data() };
                            loadAllTransactions();
                            startGlobalCountdown();
                        }
                    }
                } catch (e) {
                    console.error('Error checking login:', e);
                    showToast('Gagal memuat data user', 'error');
                }
            } else {
                window.location.href = 'prof.html';
            }
        }

        // ==================== AUTO CLEANUP FUNCTIONS ====================
        
        function startAutoCleanup() {
            // Cek setiap 1 jam
            cleanupInterval = setInterval(cleanupOldTransactions, 60 * 60 * 1000);
            
            // Cek pertama kali
            setTimeout(cleanupOldTransactions, 5000);
        }

        async function cleanupOldTransactions() {
            if (!currentUser) return;
            
            try {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                console.log('üßπ Menghapus transaksi sebelum:', sevenDaysAgo);
                
                // Cari transaksi yang lebih dari 7 hari
                const oldTransactions = await db.collection('transactions')
                    .where('userId', '==', currentUser.id)
                    .where('createdAt', '<', sevenDaysAgo)
                    .get();
                
                if (oldTransactions.empty) {
                    console.log('‚úÖ Tidak ada transaksi lama');
                    return;
                }
                
                console.log(`üóëÔ∏è Menemukan ${oldTransactions.size} transaksi lama`);
                
                // Hapus transaksi
                const batch = db.batch();
                oldTransactions.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Hapus juga token yang terkait dengan transaksi yang dihapus
                const watchTokens = await liveDb.collection('watchTokens')
                    .where('userId', '==', currentUser.id)
                    .where('createdAt', '<', sevenDaysAgo)
                    .get();
                
                if (!watchTokens.empty) {
                    const tokenBatch = liveDb.batch();
                    watchTokens.forEach(doc => {
                        tokenBatch.delete(doc.ref);
                    });
                    await tokenBatch.commit();
                    console.log(`üóëÔ∏è Menghapus ${watchTokens.size} token lama`);
                }
                
                // Reload data
                loadAllTransactions();
                showToast(`${oldTransactions.size} transaksi lama telah dihapus`, 'info');
                
            } catch (e) {
                console.error('Error cleaning up old transactions:', e);
            }
        }

        async function manualCleanup() {
            showConfirmDeleteModal();
        }

        async function deleteAllHistory() {
            hideConfirmDeleteModal();
            
            try {
                showToast('Menghapus semua riwayat...', 'info');
                
                // Hapus semua transaksi user
                const transactions = await db.collection('transactions')
                    .where('userId', '==', currentUser.id)
                    .get();
                
                const batch = db.batch();
                transactions.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Hapus semua token user
                const watchTokens = await liveDb.collection('watchTokens')
                    .where('userId', '==', currentUser.id)
                    .get();
                
                if (!watchTokens.empty) {
                    const tokenBatch = liveDb.batch();
                    watchTokens.forEach(doc => {
                        tokenBatch.delete(doc.ref);
                    });
                    await tokenBatch.commit();
                }
                
                showToast('Semua riwayat telah dihapus', 'success');
                loadAllTransactions();
                
            } catch (e) {
                console.error('Error deleting all history:', e);
                showToast('Gagal menghapus riwayat', 'error');
            }
        }

        function startGlobalCountdown() {
            updateGlobalCountdown();
            setInterval(updateGlobalCountdown, 60 * 1000); // Update setiap menit
        }

        function updateGlobalCountdown() {
            const now = new Date();
            const sevenDaysFromNow = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000));
            
            // Cari transaksi tertua
            if (allTransactions.length > 0) {
                const oldestTx = allTransactions[allTransactions.length - 1];
                if (oldestTx.createdAt) {
                    const txDate = oldestTx.createdAt.toDate();
                    const deleteDate = new Date(txDate.getTime() + (7 * 24 * 60 * 60 * 1000));
                    
                    if (deleteDate > now) {
                        const diffMs = deleteDate - now;
                        const diffDays = Math.floor(diffMs / (24 * 60 * 60 * 1000));
                        const diffHours = Math.floor((diffMs % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                        
                        document.getElementById('globalCountdown').textContent = 
                            `${diffDays} hari ${diffHours} jam`;
                        return;
                    }
                }
            }
            
            document.getElementById('globalCountdown').textContent = 'Tidak ada transaksi';
        }

        // ==================== LOAD TRANSACTIONS ====================
        
        async function loadAllTransactions() {
            if (!currentUser) return;
            
            try {
                // Ambil semua transaksi user
                const snapshot = await db.collection('transactions')
                    .where('userId', '==', currentUser.id)
                    .get();
                
                allTransactions = [];
                snapshot.forEach(doc => {
                    allTransactions.push({ id: doc.id, ...doc.data() });
                });
                
                // Urutkan dari yang terbaru
                allTransactions.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                // Hitung statistik
                updateStatistics();
                
                // Terapkan filter
                applyFilterAndSearch();
                
            } catch (e) {
                console.error('Error loading transactions:', e);
                showToast('Gagal memuat transaksi', 'error');
            }
        }

        async function updateStatistics() {
            const total = allTransactions.length;
            const totalSpent = allTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
            
            // Hitung token aktif (transaksi confirmed dalam 7 hari terakhir)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            let activeTokens = 0;
            let expiringSoon = 0;
            
            for (const tx of allTransactions) {
                if (tx.status === 'confirmed' && tx.tokens && tx.tokens.length > 0) {
                    const txDate = tx.createdAt ? tx.createdAt.toDate() : new Date();
                    const daysOld = Math.floor((new Date() - txDate) / (24 * 60 * 60 * 1000));
                    
                    activeTokens += tx.tokens.length;
                    
                    if (daysOld >= 5) { // Kurang dari 2 hari lagi akan dihapus
                        expiringSoon += tx.tokens.length;
                    }
                }
            }
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('totalSpent').textContent = 'Rp ' + totalSpent.toLocaleString('id-ID');
            document.getElementById('activeTokens').textContent = activeTokens;
            document.getElementById('expiringSoon').textContent = expiringSoon;
        }

        // ==================== FILTER & SEARCH ====================
        
        function filterTransactions(status) {
            currentFilter = status;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
                btn.classList.remove('text-white');
            });
            
            const activeBtn = document.querySelector(`[data-filter="${status}"]`);
            if (activeBtn) {
                activeBtn.style.background = '#059669';
                activeBtn.style.color = 'white';
            }
            
            applyFilterAndSearch();
        }

        function searchTransactions() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase();
            applyFilterAndSearch();
        }

        function clearFilter() {
            currentFilter = 'all';
            document.getElementById('searchInput').value = '';
            searchTerm = '';
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
            });
            
            const allBtn = document.querySelector('[data-filter="all"]');
            if (allBtn) {
                allBtn.style.background = '#059669';
                allBtn.style.color = 'white';
            }
            
            applyFilterAndSearch();
        }

        function applyFilterAndSearch() {
            // Apply status filter
            if (currentFilter === 'all') {
                filteredTransactions = [...allTransactions];
            } else {
                filteredTransactions = allTransactions.filter(t => t.status === currentFilter);
            }
            
            // Apply search
            if (searchTerm) {
                filteredTransactions = filteredTransactions.filter(t => {
                    // Cari di nama produk
                    if (t.productName && t.productName.toLowerCase().includes(searchTerm)) return true;
                    
                    // Cari di token
                    if (t.tokens && t.tokens.some(token => token.toLowerCase().includes(searchTerm))) return true;
                    
                    // Cari di nominal
                    if (t.amount && t.amount.toString().includes(searchTerm)) return true;
                    
                    return false;
                });
            }
            
            displayedCount = 10;
            renderTransactions();
        }

        // ==================== RENDER TRANSACTIONS ====================
        
        function renderTransactions() {
            const container = document.getElementById('transactionsList');
            const emptyState = document.getElementById('emptyState');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            
            if (filteredTransactions.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                loadMoreContainer.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            const displayTransactions = filteredTransactions.slice(0, displayedCount);
            
            container.innerHTML = '';
            displayTransactions.forEach(t => {
                container.innerHTML += createTransactionCard(t);
            });
            
            if (filteredTransactions.length > displayedCount) {
                loadMoreContainer.classList.remove('hidden');
            } else {
                loadMoreContainer.classList.add('hidden');
            }
        }

        function createTransactionCard(t) {
            const createdDate = t.createdAt ? t.createdAt.toDate() : new Date();
            const dateStr = createdDate.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Hitung hari tersisa sebelum dihapus
            const deleteDate = new Date(createdDate.getTime() + (7 * 24 * 60 * 60 * 1000));
            const now = new Date();
            const daysLeft = Math.ceil((deleteDate - now) / (24 * 60 * 60 * 1000));
            
            const statusColors = {
                pending: 'bg-yellow-100 text-yellow-700',
                confirmed: 'bg-emerald-100 text-emerald-700',
                rejected: 'bg-red-100 text-red-700'
            };
            
            const statusIcons = {
                pending: '‚è≥',
                confirmed: '‚úÖ',
                rejected: '‚ùå'
            };
            
            const statusText = {
                pending: 'Menunggu',
                confirmed: 'Berhasil',
                rejected: 'Ditolak'
            };
            
            // Generate token HTML jika ada
            const tokensHtml = t.tokens && t.tokens.length > 0 ? `
                <div class="mt-4 pt-4 border-t border-divider/30">
                    <p class="text-sm font-medium text-dark mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                        </svg>
                        Token Nonton (${t.tokens.length})
                    </p>
                    <div class="grid grid-cols-2 gap-2">
                        ${t.tokens.map(token => `
                            <div class="token-item flex items-center justify-between p-2 rounded-xl bg-gray-50">
                                <span class="font-mono text-xs text-emerald-600 truncate max-w-[100px]">${token}</span>
                                <button onclick="copyToken('${token}')" class="text-emerald-600 hover:text-emerald-700 p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 hover:border-emerald-200 transition-all cursor-pointer" onclick="showTransactionDetail('${t.id}')">
                    <div class="flex items-start justify-between">
                        <div class="flex gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-emerald-100 to-emerald-200 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-dark">${t.productName || 'Produk'}</h4>
                                <p class="text-sm text-secondary">${dateStr}</p>
                                <p class="text-xl font-bold text-emerald-600 mt-1">Rp ${(t.amount || 0).toLocaleString('id-ID')}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="status-badge ${statusColors[t.status] || 'bg-gray-100'}">
                                ${statusIcons[t.status] || ''} ${statusText[t.status] || t.status}
                            </span>
                            ${t.status === 'confirmed' ? `
                                <p class="text-xs text-gray-400 mt-2 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    ${daysLeft > 0 ? `Hapus dalam ${daysLeft} hari` : 'Segera dihapus'}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                    ${tokensHtml}
                </div>
            `;
        }

        function loadMoreTransactions() {
            displayedCount += 10;
            renderTransactions();
        }

        // ==================== TRANSACTION DETAIL ====================
        
        async function showTransactionDetail(transactionId) {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            const createdDate = transaction.createdAt ? transaction.createdAt.toDate() : new Date();
            const dateStr = createdDate.toLocaleString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Hitung waktu penghapusan
            const deleteDate = new Date(createdDate.getTime() + (7 * 24 * 60 * 60 * 1000));
            const now = new Date();
            const timeLeft = deleteDate - now;
            const daysLeft = Math.floor(timeLeft / (24 * 60 * 60 * 1000));
            const hoursLeft = Math.floor((timeLeft % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
            
            const statusColors = {
                pending: 'bg-yellow-100 text-yellow-700',
                confirmed: 'bg-emerald-100 text-emerald-700',
                rejected: 'bg-red-100 text-red-700'
            };
            
            const statusText = {
                pending: 'Menunggu Konfirmasi',
                confirmed: 'Pembayaran Diterima',
                rejected: 'Ditolak'
            };
            
            let detailHtml = `
                <div class="flex items-center justify-between pb-3 border-b border-divider">
                    <span class="text-secondary">Status</span>
                    <span class="status-badge ${statusColors[transaction.status]}">
                        ${statusText[transaction.status] || transaction.status}
                    </span>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-secondary">Produk</span>
                    <span class="font-medium text-dark">${transaction.productName || '-'}</span>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-secondary">Tipe</span>
                    <span class="font-medium text-dark">${transaction.productType === 'membership' ? 'Membership' : 'Token'}</span>
                </div>
                
                ${transaction.tokenCount ? `
                <div class="flex items-center justify-between">
                    <span class="text-secondary">Jumlah Token</span>
                    <span class="font-medium text-dark">${transaction.tokenCount} Token</span>
                </div>
                ` : ''}
                
                ${transaction.monthCount ? `
                <div class="flex items-center justify-between">
                    <span class="text-secondary">Durasi</span>
                    <span class="font-medium text-dark">${transaction.monthCount} Bulan</span>
                </div>
                ` : ''}
                
                <div class="flex items-center justify-between pt-3 border-t border-divider">
                    <span class="text-secondary">Total Pembayaran</span>
                    <span class="text-xl font-bold text-emerald-600">Rp ${(transaction.amount || 0).toLocaleString('id-ID')}</span>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-secondary">Metode</span>
                    <span class="font-medium text-dark">${transaction.paymentMethod === 'saldo' ? 'Bayar dengan Saldo' : 'Transfer QRIS'}</span>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-secondary">Tanggal</span>
                    <span class="font-medium text-dark">${dateStr}</span>
                </div>
                
                ${transaction.status === 'confirmed' ? `
                <div class="bg-emerald-50 rounded-xl p-4">
                    <p class="text-sm font-medium text-emerald-800 mb-2 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Token akan otomatis terhapus dalam:
                    </p>
                    <p class="text-lg font-bold text-emerald-700">
                        ${daysLeft > 0 ? `${daysLeft} hari ${hoursLeft} jam` : 'Kurang dari 1 jam'}
                    </p>
                </div>
                ` : ''}
            `;
            
            // Tambahkan token jika ada
            if (transaction.tokens && transaction.tokens.length > 0) {
                detailHtml += `
                    <div class="pt-3 border-t border-divider">
                        <p class="text-sm font-medium text-dark mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                            </svg>
                            Token Nonton (${transaction.tokens.length})
                        </p>
                        <div class="space-y-2">
                            ${transaction.tokens.map(token => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                    <span class="font-mono text-sm text-emerald-600">${token}</span>
                                    <button onclick="copyToken('${token}')" class="text-emerald-600 hover:text-emerald-700 px-3 py-1 rounded-lg hover:bg-emerald-50 transition-colors">
                                        Salin
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (transaction.proofImage) {
                detailHtml += `
                    <div class="pt-3 border-t border-divider">
                        <p class="text-sm font-medium text-dark mb-2">Bukti Transfer</p>
                        <img src="${transaction.proofImage}" alt="Bukti Transfer" class="w-full max-w-[200px] mx-auto rounded-xl border border-divider">
                    </div>
                `;
            }
            
            document.getElementById('detailContent').innerHTML = detailHtml;
            
            const detailActions = document.getElementById('detailActions');
            if (transaction.status === 'pending') {
                detailActions.innerHTML = `
                    <button onclick="contactAdmin('${transaction.userPhone}')" class="flex-1 py-3 bg-emerald-50 text-emerald-600 font-medium rounded-xl hover:bg-emerald-100 transition-colors">
                        Hubungi Admin
                    </button>
                    <button onclick="hideDetailModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                        Tutup
                    </button>
                `;
            } else {
                detailActions.innerHTML = `
                    <button onclick="hideDetailModal()" class="w-full py-3 bg-emerald-500 text-white font-medium rounded-xl hover:bg-emerald-600 transition-colors">
                        Tutup
                    </button>
                `;
            }
            
            showDetailModal();
        }

        // ==================== TOKEN FUNCTIONS ====================
        
        function copyToken(token) {
            navigator.clipboard.writeText(token);
            showToast('Token disalin!', 'success');
        }

        function copyAllTokens(transactionId) {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (transaction && transaction.tokens) {
                navigator.clipboard.writeText(transaction.tokens.join('\n'));
                showToast('Semua token disalin!', 'success');
            }
        }

        // ==================== MODAL CONTROLS ====================
        
        function showDetailModal() {
            document.getElementById('detailModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('detailModalContent').classList.remove('translate-y-full'), 10);
        }

        function hideDetailModal() {
            document.getElementById('detailModalContent').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('detailModal').classList.add('hidden'), 300);
        }

        function showTokenModal() {
            document.getElementById('tokenModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('tokenModalContent').classList.remove('translate-y-full'), 10);
        }

        function hideTokenModal() {
            document.getElementById('tokenModalContent').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('tokenModal').classList.add('hidden'), 300);
        }

        function showConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').classList.remove('hidden');
        }

        function hideConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').classList.add('hidden');
        }

        // ==================== CONTACT ADMIN ====================
        
        function contactAdmin(phone) {
            const adminPhone = '6281234567890';
            const message = encodeURIComponent(`Halo admin, saya ingin menanyakan status transaksi saya. No. WhatsApp terdaftar: ${phone}`);
            window.open(`https://wa.me/${adminPhone}?text=${message}`, '_blank');
        }

        // ==================== TOAST ====================
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            
            const icons = {
                success: '<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
                error: '<svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
                info: '<svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            };
            
            document.getElementById('toastIcon').innerHTML = icons[type] || icons.info;
            toast.classList.remove('opacity-0', '-translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', '-translate-y-4');
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (cleanupInterval) {
                clearInterval(cleanupInterval);
            }
        });
    </script>
</body>
</html>
